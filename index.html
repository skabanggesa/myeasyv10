<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Analisis SKAG V10.0 - Terintegrasi Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Great+Vibes&display=swap');
        
        @media print {
            body * { visibility: hidden; }
            #section-sijil, #section-sijil * { visibility: visible; }
            #section-sijil { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
            .page-break { page-break-after: always; }
        }

        .certificate-border { 
            border: 20px double #1e3a8a; 
            padding: 50px; 
            background: white; 
            min-height: 1050px; 
            display: flex; 
            flex-direction: column; 
            position: relative;
        }
        .mark-input { width: 50px; padding: 4px; text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; font-weight: bold; }
        
        /* Loading overlay semasa menyemak status login */
        #loading-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800 text-sm">

<div id="loading-overlay">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-900 mb-4"></div>
    <p class="font-bold text-blue-900 animate-pulse">MENYEMAK AKSES PORTAL...</p>
</div>

<div id="main-content" class="hidden">
    <div class="bg-white p-5 shadow-sm border-b-4 border-blue-900 no-print">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <img src="logo.png" class="w-16 h-16" onerror="this.style.display='none'">
                <div>
                    <h1 class="text-xl font-black text-blue-900 uppercase">SK ABANG GESA, BELAWAI</h1>
                    <p id="user-welcome" class="text-[10px] font-bold text-blue-500 tracking-widest uppercase">MyEASy V10.0 | LOG MASUK SEBAGAI: ...</p>
                </div>
            </div>
            <button onclick="logoutPortal()" class="bg-slate-700 text-white px-5 py-2 rounded-lg font-bold text-xs uppercase">üö™ Log Keluar Portal</button>
        </div>
    </div>

    <div class="container mx-auto p-6 no-print">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <div class="space-y-4">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-xs text-blue-700 uppercase mb-4 border-b pb-2 text-[10px]">‚öôÔ∏è Tetapan Sesi</h2>
                    
                    <label class="text-[10px] font-bold text-slate-400 block mb-1">SESI AKADEMIK</label>
                    <select id="sesiAkademik" onchange="loadClassList()" class="w-full p-2 border rounded font-bold text-blue-900 mb-4 bg-blue-50">
                        <option value="2024_2025">2024/2025</option>
                        <option value="2025_2026">2025/2026</option>
                        <option value="2026_2027">2026/2027</option>
                        <option value="2027_2028">2027/2028</option>
                        <option value="2028_2029">2028/2029</option>
                        <option value="2029_2030">2029/2030</option>
                    </select>

                    <label class="text-[10px] font-bold text-slate-400 block mb-1">JENIS PENTAKSIRAN</label>
                    <select id="sesiPentaksiran" onchange="startSync()" class="w-full p-2 border rounded font-bold text-emerald-800 mb-4 bg-emerald-50">
                        <option value="Ujian Akhir Sesi Akademik (UASA)">UJIAN AKHIR SESI AKADEMIK</option>
                        <option value="Pentaksiran Pertengahan Tahun">PENILAIAN PERTENGAHAN TAHUN</option>
                        <option value="UPDLP">UJIAN PENILAIAN DUAL LANGUAGE PROGRAMME</option>
                    </select>

                    <div id="class-area" class="hidden">
                        <label class="text-[10px] font-bold text-slate-400 block mb-1">PILIH KELAS</label>
                        <select id="classDropdown" onchange="startSync()" class="w-full p-2 border border-amber-300 rounded font-bold text-blue-900 bg-amber-50"></select>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-xs text-blue-700 uppercase mb-3 text-[10px]">üì• IMPORT SENARAI MURID (CSV)</h2>
                    <input type="file" id="csvInput" accept=".csv" class="w-full text-[10px] mb-2">
                    <button onclick="processCSV()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded text-[10px] font-bold uppercase">Proses Fail CSV</button>
                </div>

                <div class="bg-slate-800 p-5 rounded-xl shadow-lg border text-white">
                    <h2 class="font-black text-[10px] text-yellow-400 uppercase mb-3 border-b border-slate-600 pb-1">‚öôÔ∏è DATA MANAGER</h2>
                    <div class="space-y-2">
                        <button onclick="backupDatabase()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded text-[10px] font-bold">üíæ SIMPAN BACKUP</button>
                        <div class="border border-slate-600 p-2 rounded bg-slate-700">
                            <input type="file" id="importJsonInput" accept=".json" class="hidden" onchange="processJsonImport(this)">
                            <button onclick="document.getElementById('importJsonInput').click()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded text-[10px] font-bold">üìÇ MUAT NAIK BACKUP</button>
                        </div>
                        <button onclick="clearAllData()" class="w-full bg-red-600 hover:bg-red-500 text-white py-2 rounded text-[10px] font-bold">üö® PADAM SEMUA DATA INI</button>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-xs text-blue-700 uppercase mb-3 text-[10px]">üìö Matapelajaran</h2>
                    <div id="subject-grid" class="grid grid-cols-1 gap-1 max-h-48 overflow-y-auto text-[10px]"></div>
                </div>
            </div>

            <div class="lg:col-span-3 space-y-6">
                <div id="dashboard" class="grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border-l-8 border-blue-600 text-center">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">GPM KELAS</p>
                        <p id="stat-gpm" class="text-3xl font-black text-blue-900">-</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border-l-8 border-emerald-500 text-center">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">% Lulus</p>
                        <p id="stat-lulus" class="text-3xl font-black text-emerald-600">-</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border-l-8 border-orange-400 text-center">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Murid</p>
                        <p id="stat-murid" class="text-3xl font-black text-slate-800">-</p>
                    </div>
                    <button onclick="calculate()" class="bg-blue-900 text-white rounded-2xl font-black text-sm uppercase shadow-xl hover:scale-105 transition">üöÄ Jana Sijil & Analisis</button>
                </div>

                <div id="excellence-panel" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                    <div class="bg-white p-5 rounded-xl border-t-4 border-emerald-500 shadow-sm">
                        <h3 class="font-black text-emerald-700 text-xs mb-3 border-b pb-2 uppercase tracking-tighter">üèÜ 5 Pelajar Terbaik Keseluruhan</h3>
                        <div id="top-5-list" class="space-y-2 text-[11px]"></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl border-t-4 border-amber-400 shadow-sm">
                        <h3 class="font-black text-blue-900 text-xs mb-3 border-b pb-2 uppercase tracking-tighter">‚≠ê Murid Terbaik Ikut Subjek</h3>
                        <div id="subject-best-list" class="grid grid-cols-1 gap-1 text-[11px]"></div>
                    </div>
                </div>

                <div id="table-card" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden hidden">
                    <div class="p-4 bg-slate-50 border-b flex items-center gap-3">
                        <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="Cari nama murid..." class="flex-1 p-2 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-6 py-2 rounded-xl font-bold text-xs">üìä EXCEL</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-blue-900 text-white text-[10px] uppercase"><tr id="tableHeader"></tr></thead>
                            <tbody id="tableBody" class="text-xs"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="print-btn-area" class="hidden flex justify-center pb-24">
                    <button onclick="window.print()" class="bg-blue-900 text-white px-16 py-5 rounded-full font-black text-xl shadow-2xl">üñ®Ô∏è CETAK SEMUA SIJIL</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="section-sijil"></div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCwh99Ui4KPXgC-W-CpCg-edYnHN3aVmrk",
    authDomain: "portal-8368.firebaseapp.com",
    projectId: "portal-8368",
    storageBucket: "portal-8368.firebasestorage.app",
    messagingSenderId: "150403488308",
    appId: "1:150403488308:web:fac9b3c52dcd9975130861"
};

    const KPM_SUBJECTS = [
        {id:'BM', name:'BAHASA MELAYU'}, {id:'BI', name:'BAHASA INGGERIS'}, {id:'MT', name:'MATEMATIK'}, 
        {id:'SN', name:'SAINS'}, {id:'SJ', name:'SEJARAH'}, {id:'PAI', name:'PENDIDIKAN ISLAM'},
        {id:'MZ', name:'PENDIDIKAN MUZIK'}, {id:'PJK', name:'PENDIDIKAN JASMANI KESIHATAN'}, 
        {id:'PSV', name:'PENDIDIKAN SENI VISUAL'}, {id:'RBT', name:'REKA BENTUK TEKNOLOGI'}
    ];

    let db, currentClassData = [], selectedSubjects = [];

    window.onload = () => { 
        firebase.initializeApp(firebaseConfig); 
        db = firebase.firestore(); 
        renderSubjectGrid(); 
        initSingleSignIn(); // Memulakan SSO
    };

// GANTIKAN FUNGSI SSO LAMA KEPADA INI
function initSingleSignIn() {
    // Gunakan 'onAuthStateChanged' dari modular, bukan firebase.auth()
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // User sudah login
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('main-content').classList.remove('hidden');
            
            // Ambil nama profil (jika ada) atau guna emel
            const namaPaparan = await fetchTeacherName(user); 
            document.getElementById('user-welcome').innerText = `MyEASy V10.0 | LOG MASUK SEBAGAI: ${namaPaparan}`;
            
            loadClassList();
        } else {
            // User belum login - Hantar balik ke Portal SAGE
            document.getElementById('loading-overlay').innerHTML = `
                <div class="text-center">
                    <p class="text-red-600 font-bold">AKSES DITOLAK: SILA LOG MASUK PORTAL DULU</p>
                    <p class="text-xs text-gray-500 mb-4">Anda akan dibawa ke portal utama...</p>
                    <button onclick="window.location.href='http://skabanggesa.github.io/sage'" 
                            class="bg-blue-900 text-white px-6 py-2 rounded-xl font-bold">
                        KE PORTAL SAGE
                    </button>
                </div>
            `;
            // Opsyenal: Redirect automatik selepas 3 saat
            setTimeout(() => {
                window.location.href = "http://skabanggesa.github.io/sage";
            }, 3000);
        }
    });
}

    // SEMUA FUNGSI ASAL DIKEKALKAN
    function renderSubjectGrid() {
        const grid = document.getElementById('subject-grid');
        KPM_SUBJECTS.forEach(sub => {
            grid.innerHTML += `<label class="flex items-center space-x-3 p-1.5 hover:bg-slate-50 cursor-pointer rounded"><input type="checkbox" value="${sub.id}" class="sub-checkbox w-4 h-4" checked onchange="updateSelectedSubjects()"> <span class="font-medium">${sub.name}</span></label>`;
        });
        updateSelectedSubjects();
    }
    
    function updateSelectedSubjects() { 
        selectedSubjects = Array.from(document.querySelectorAll('.sub-checkbox:checked')).map(cb => cb.value); 
        if (currentClassData.length > 0) renderTable(); 
    }

    async function loadClassList() {
        const sesi = document.getElementById('sesiAkademik').value;
        const snap = await db.collection('sesi').doc(sesi).collection('kelas').get();
        document.getElementById('classDropdown').innerHTML = '<option value="">-- Pilih Kelas --</option>' + snap.docs.map(d => `<option value="${d.id}">${d.data().nama_kelas || d.id}</option>`).join('');
        document.getElementById('class-area').classList.remove('hidden');
    }

    function startSync() {
        const sesi = document.getElementById('sesiAkademik').value;
        const jenis = document.getElementById('sesiPentaksiran').value.replace(/\s+/g,'_');
        const kelas = document.getElementById('classDropdown').value;
        if(!kelas) return;

        db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(kelas).collection('murid')
            .onSnapshot(snap => {
                currentClassData = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderTable();
            });
    }

    async function updateMark(sid, sub, val) {
        const sesi = document.getElementById('sesiAkademik').value;
        const jenis = document.getElementById('sesiPentaksiran').value.replace(/\s+/g,'_');
        const kelas = document.getElementById('classDropdown').value;
        await db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(kelas).collection('murid').doc(sid).set({ marks: {[sub]: parseFloat(val) || 0} }, {merge: true});
    }

    async function processCSV() {
        const file = document.getElementById('csvInput').files[0];
        const sesi = document.getElementById('sesiAkademik').value;
        const jenis = document.getElementById('sesiPentaksiran').value.replace(/\s+/g,'_');
        if (!file) return alert("Pilih fail CSV!");
        
        Papa.parse(file, {
            header: true, skipEmptyLines: true,
            complete: async (res) => {
                const batch = db.batch();
                res.data.forEach(row => {
                    const rowData = Object.keys(row).reduce((acc, k) => { acc[k.toLowerCase().trim()] = row[k]; return acc; }, {});
                    if (rowData.nama && rowData.kelas) {
                        const cid = rowData.kelas.toString().replace(/\s+/g,'_').toUpperCase();
                        const cref = db.collection('sesi').doc(sesi).collection('kelas').doc(cid);
                        const mref = db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(cid).collection('murid').doc();
                        batch.set(cref, { nama_kelas: rowData.kelas.toUpperCase() }, { merge: true });
                        batch.set(mref, { nama: rowData.nama.toUpperCase(), marks: {} });
                    }
                });
                await batch.commit(); alert("Data berjaya diimport ke " + jenis + "!"); loadClassList();
            }
        });
    }

    function renderTable() {
        const search = document.getElementById('searchInput').value.toUpperCase();
        const header = document.getElementById('tableHeader');
        const body = document.getElementById('tableBody');
        header.innerHTML = `<th class="p-4">NAMA MURID</th>` + selectedSubjects.map(s => `<th class="p-2 text-center bg-blue-800">${s}</th>`).join('') + `<th class="p-2 text-center bg-slate-700">GPM</th><th class="p-2 text-center bg-red-600">X</th>`;
        const sorted = [...currentClassData].filter(m => m.nama.includes(search)).sort((a,b) => a.nama.localeCompare(b.nama));
        body.innerHTML = sorted.map(m => `
            <tr class="border-b hover:bg-blue-50">
                <td class="p-4 font-bold uppercase text-slate-700">${m.nama}</td>
                ${selectedSubjects.map(sub => `<td class="p-2 text-center"><input type="number" class="mark-input" value="${m.marks?.[sub] || 0}" onchange="updateMark('${m.id}', '${sub}', this.value)"></td>`).join('')}
                <td class="p-2 text-center font-black text-blue-600">${m.gpm || '0.00'}</td>
                <td class="p-2 text-center"><button onclick="deleteStudent('${m.id}')" class="text-red-300">üóëÔ∏è</button></td>
            </tr>`).join('');
        document.getElementById('table-card').classList.remove('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('stat-murid').innerText = currentClassData.length;
    }

    function calculate() {
        const getGrade = (m) => {
            if (m >= 80) return { g: 'A', p: 1 }; if (m >= 70) return { g: 'B', p: 2 }; if (m >= 60) return { g: 'C', p: 3 };
            if (m >= 50) return { g: 'D', p: 4 }; if (m >= 40) return { g: 'E', p: 5 }; return { g: 'F', p: 6 };
        };
        const coreSubjects = ['BM', 'BI', 'MT', 'SN', 'SJ'];
        let totalPassClass = 0;
        
        currentClassData.forEach(s => {
            let tm = 0, tp = 0, isLulusHeadcount = true;
            selectedSubjects.forEach(sub => {
                let m = s.marks?.[sub] || 0; let res = getGrade(m);
                tm += m; tp += res.p; if(coreSubjects.includes(sub) && m < 40) isLulusHeadcount = false;
            });
            s.totalMarks = tm; s.gpm = (tp / (selectedSubjects.length || 1)).toFixed(2);
            s.percent = ((tm / (selectedSubjects.length * 100)) * 100).toFixed(2);
            s.statusLulus = isLulusHeadcount ? "LULUS" : "GAGAL"; if(isLulusHeadcount) totalPassClass++;
        });

        const sortedByRank = [...currentClassData].sort((a,b) => a.gpm - b.gpm || b.totalMarks - a.totalMarks);
        currentClassData.forEach(s => s.rank = sortedByRank.findIndex(r => r.id === s.id) + 1);

        document.getElementById('top-5-list').innerHTML = sortedByRank.slice(0, 5).map((s, idx) => `
            <div class="flex justify-between items-center p-2 border-b">
                <span>${idx + 1}. <b>${s.nama}</b></span>
                <span class="bg-emerald-100 text-emerald-800 px-2 py-0.5 rounded font-black">GPM: ${s.gpm}</span>
            </div>`).join('');
        
        let bestSubHtml = '';
        selectedSubjects.forEach(sub => {
            const marksList = currentClassData.map(m => m.marks?.[sub] || 0);
            const maxMark = Math.max(...marksList);
            if (maxMark > 0) {
                const winners = currentClassData.filter(m => (m.marks?.[sub] || 0) === maxMark);
                const winnerNames = winners.map(w => w.nama).join(', ');
                bestSubHtml += `
                    <div class="p-2 bg-blue-50 border-l-4 border-blue-900 rounded mb-1 flex flex-col">
                        <span class="font-black text-blue-900 uppercase text-[9px]">${KPM_SUBJECTS.find(k=>k.id===sub).name}</span>
                        <div class="flex justify-between"><span class="font-bold text-slate-700 truncate mr-2">${winnerNames}</span><span class="bg-blue-900 text-white px-2 py-0.5 rounded text-[10px] font-black">${maxMark}</span></div>
                    </div>`;
            }
        });
        document.getElementById('subject-best-list').innerHTML = bestSubHtml;
        document.getElementById('excellence-panel').classList.remove('hidden');
        document.getElementById('stat-gpm').innerText = (currentClassData.reduce((a,b) => a + parseFloat(b.gpm), 0) / (currentClassData.length || 1)).toFixed(2);
        document.getElementById('stat-lulus').innerText = ((totalPassClass / (currentClassData.length || 1)) * 100).toFixed(1) + "%";
        generateSijil(getGrade); renderTable();
        document.getElementById('print-btn-area').classList.remove('hidden');
    }

    function generateSijil(getGrade) {
        const sortedAZ = [...currentClassData].sort((a, b) => a.nama.localeCompare(b.nama));
        const pentaksiran = document.getElementById('sesiPentaksiran').value;
        document.getElementById('section-sijil').innerHTML = sortedAZ.map(s => `
            <div class="page-break"><div class="certificate-border">
                <div class="text-center mb-10"><img src="logo.png" class="w-20 mx-auto mb-4"><h2 class="text-2xl font-black text-blue-900">SK ABANG GESA, BELAWAI</h2><p class="text-xs font-bold text-slate-500 uppercase">${pentaksiran}</p></div>
                <div class="text-center mb-8"><h1 style="font-family: 'Cinzel', serif;" class="text-5xl font-bold text-blue-900">SIJIL PENCAPAIAN</h1><p class="mt-6 italic text-sm text-slate-500">Dianugerahkan kepada</p><h2 class="text-3xl font-black my-4 uppercase text-blue-950 border-b-4 border-double border-blue-900 inline-block px-12 pb-2">${s.nama}</h2></div>
                <div class="flex justify-center flex-grow py-4">
                    <table class="w-11/12 border-2 border-slate-800 text-[11px]">
                        <thead class="bg-blue-900 text-white uppercase text-sm"><tr><th class="p-3 border text-left">MATAPELAJARAN</th><th class="p-3 border text-center">MARKAH</th><th class="p-3 border text-center">GRED</th></tr></thead>
                        <tbody class="font-bold">
                            ${selectedSubjects.map(sub => `<tr><td class="border border-slate-800 p-2 px-6 uppercase">${KPM_SUBJECTS.find(k=>k.id===sub).name}</td><td class="border border-slate-800 text-center p-2 text-base">${s.marks?.[sub] || 0}</td><td class="border border-slate-800 text-center p-2 text-base font-black text-blue-900">${getGrade(s.marks?.[sub] || 0).g}</td></tr>`).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 grid grid-cols-4 gap-4 text-center max-w-3xl mx-auto font-black text-xs">
                    <div class="bg-slate-100 p-3 border rounded-xl">GPM: ${s.gpm}</div><div class="bg-slate-100 p-3 border rounded-xl">KEDUDUKAN: ${s.rank}</div>
                    <div class="bg-blue-900 text-white p-3 rounded-xl uppercase">${s.statusLulus}</div><div class="bg-slate-100 p-3 border rounded-xl">PERATUS: ${s.percent}%</div>
                </div>
                <div class="mt-20 flex justify-between px-16 text-sm font-black text-center uppercase"><div class="w-56"><div class="border-b-2 border-black h-12 mb-2"></div><p>Guru Kelas</p></div><div class="w-56"><div class="border-b-2 border-black h-12 mb-2"></div><p>Guru Besar</p></div></div>
            </div></div>`).join('');
    }

    async function backupDatabase() {
        const sesi = document.getElementById('sesiAkademik').value;
        const jenis = document.getElementById('sesiPentaksiran').value.replace(/\s+/g,'_');
        const backupData = { app: "SKAG", sesiAsal: sesi, pentaksiran: jenis, content: [] };
        const kelasSnap = await db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').get();
        for (const kDoc of kelasSnap.docs) {
            const mSnap = await db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(kDoc.id).collection('murid').get();
            backupData.content.push({ kelasId: kDoc.id, namaKelas: kDoc.data()?.nama_kelas || kDoc.id, senaraiMurid: mSnap.docs.map(m => m.data()) });
        }
        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json" });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `BACKUP_SKAG_${jenis}_${sesi}.json`; a.click();
    }

    async function processJsonImport(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader(); reader.onload = async (e) => {
            const data = JSON.parse(e.target.result); 
            const sesi = document.getElementById('sesiAkademik').value;
            const jenis = document.getElementById('sesiPentaksiran').value.replace(/\s+/g,'_');
            if(!confirm(`Import data ke ${jenis} (${sesi})?`)) return;
            for (const item of data.content) {
                const kRef = db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(item.kelasId);
                await kRef.set({ nama_kelas: item.namaKelas }, { merge: true });
                const batch = db.batch();
                item.senaraiMurid.forEach(m => batch.set(kRef.collection('murid').doc(), m));
                await batch.commit();
            }
            alert("Backup Berjaya Dimuat Naik!"); location.reload();
        }; reader.readAsText(file);
    }

// 1. FUNGSI PADAM SEMUA DATA BAGI SATU PENTAKSIRAN
async function clearAllData() {
    const sesi = document.getElementById('sesiAkademik').value;
    // .trim() dan .replace() memastikan nama pentaksiran sepadan dengan Database
    const jenisRaw = document.getElementById('sesiPentaksiran').value;
    const jenis = jenisRaw.trim().replace(/\s+/g,'_');
    
    console.log("Memulakan pemadaman di:", `sesi/${sesi}/pentaksiran/${jenis}`);

    const confirmation = confirm(`AMARAN: Padam semua data bagi ${jenisRaw} (${sesi})?`);
    if(!confirmation || prompt("Taip 'PADAM' untuk sahkan:") !== "PADAM") return;

    try {
        // Ambil semua dokumen kelas di bawah pentaksiran tersebut
        const snap = await db.collection('sesi').doc(sesi)
                           .collection('pentaksiran').doc(jenis)
                           .collection('kelas').get();
        
        if (snap.empty) {
            console.warn("Tiada koleksi 'kelas' dijumpai di laluan tersebut.");
            alert("DATA TIDAK DIJUMPAI.\n\nSistem cari: " + jenis + "\nSila pastikan pilihan Pentaksiran adalah betul.");
            return;
        }

        const batch = db.batch();
        let totalDeleted = 0;

        for (const kDoc of snap.docs) {
            // Ambil semua murid dalam setiap kelas
            const mSnap = await kDoc.ref.collection('murid').get();
            mSnap.forEach(m => {
                batch.delete(m.ref);
                totalDeleted++;
            });
            batch.delete(kDoc.ref); // Padam dokumen kelas itu sendiri
        }

        await batch.commit();
        alert(`BERJAYA: Rekod bagi ${snap.docs.length} kelas (${totalDeleted} murid) telah dibersihkan.`);
        location.reload();

    } catch (error) {
        console.error("Ralat pemadaman:", error);
        alert("Ralat teknikal (Sila semak konsol): " + error.message);
    }
}

// 2. FUNGSI PADAM SEORANG MURID (TELAH DIBAIKI)
async function deleteStudent(sid) {
    if(!confirm("Padam rekod murid ini?")) return;
    
    const sesi = document.getElementById('sesiAkademik').value;
    const jenis = document.getElementById('sesiPentaksiran').value.trim().replace(/\s+/g,'_'); // DITAMBAH .replace()
    const kelas = document.getElementById('classDropdown').value;

    try {
        await db.collection('sesi').doc(sesi)
                .collection('pentaksiran').doc(jenis)
                .collection('kelas').doc(kelas)
                .collection('murid').doc(sid).delete();
        console.log("Murid dipadam:", sid);
    } catch (error) {
        alert("Ralat memadam murid: " + error.message);
    }
}
    function exportToExcel() {
        const data = [...currentClassData].sort((a,b)=>a.nama.localeCompare(b.nama)).map(m => ({ Nama: m.nama, ...m.marks, GPM: m.gpm, Rank: m.rank, Status: m.statusLulus }));
        const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Analisis"); XLSX.writeFile(wb, `Analisis_SKAG_${Date.now()}.xlsx`);
    }
</script>
</body>
</html>





