<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malaysian Exam Analysis System V13.0 - DELIMa Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Great+Vibes&family=Inter:wght@400;700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; }

        @media print {
            body * { visibility: hidden; }
            #section-sijil, #section-sijil * { visibility: visible; }
            #section-sijil { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .page-break { page-break-after: always; break-after: page; display: block; height: 100vh; position: relative; }
        }

        .certificate-border { 
            border: 20px double #1e3a8a; 
            padding: 40px; 
            background: white; 
            height: 98vh; 
            box-sizing: border-box;
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
        }

        .mark-input { width: 50px; padding: 4px; text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; font-weight: bold; transition: all 0.2s; }
        .mark-input:focus { border-color: #1e3a8a; outline: none; box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1); }

        #auth-overlay { position: fixed; inset: 0; background: #f8fafc; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 8px; color: white; font-weight: bold; font-size: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .google-btn {
            display: flex; align-items: center; justify-content: center; gap: 12px;
            background: white; color: #374151; font-weight: 700; padding: 14px 24px;
            border-radius: 16px; border: 1px solid #e2e8f0; transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); width: 100%;
        }
        .google-btn:hover { background: #f9fafb; border-color: #cbd5e1; transform: translateY(-1px); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 text-sm">

<div id="toast-container"></div>

<div id="auth-overlay">
    <div id="loading-state" class="text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-900 mb-4 mx-auto"></div>
        <p class="font-bold text-blue-900 animate-pulse uppercase tracking-widest text-[10px]">Menghubungkan ke Cloud...</p>
    </div>

    <div id="login-state" class="hidden text-center bg-white p-10 rounded-[2.5rem] shadow-2xl border border-slate-100 max-w-sm w-full mx-4">
        <div class="mb-8">
            <img src="myeasy.png" alt="Logo MyEasy" class="w-32 mx-auto drop-shadow-md">
        </div>
        
        <h2 class="text-2xl font-black text-blue-900 mb-1 leading-tight uppercase tracking-tight">ANALISIS SKAG</h2>
        <p class="text-[10px] font-bold text-slate-400 uppercase mb-10 tracking-[0.2em]">Pencapaian Digital Murid</p>

        <div class="space-y-4">
            <button onclick="loginWithGoogle()" class="google-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
                <span class="text-sm">Masuk dengan Akaun DELIMa</span>
            </button>
            <div class="pt-6 border-t border-slate-100">
                <p class="text-[9px] text-slate-400 font-bold px-4 leading-relaxed uppercase">
                    Kebenaran Akses: <br>
                    <span class="text-blue-600">@moe-dl.edu.my</span> (Guru) <br>
                    <span class="text-blue-600">@moe.edu.my</span> (Pegawai)
                </p>
            </div>
        </div>
        
        <div id="login-error" class="mt-6 p-4 bg-red-50 text-red-600 text-[10px] font-bold rounded-2xl hidden border border-red-100"></div>
    </div>
</div>

<div id="main-content" class="hidden">
    <div class="bg-white p-5 shadow-sm border-b-4 border-blue-900 no-print">
        <div class="container mx-auto flex justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <img src="myeasy.png" class="h-10">
                <div>
                    <h1 class="text-xl font-black text-blue-900 uppercase leading-none tracking-tighter">SK ABANG GESA, BELAWAI</h1>
                    <p id="user-welcome" class="text-[10px] font-bold text-emerald-600 uppercase mt-1 tracking-wider italic">...</p>
                </div>
            </div>
            <button onclick="logoutSystem()" class="bg-slate-100 hover:bg-red-50 hover:text-red-600 text-slate-500 px-5 py-2 rounded-xl font-black text-[10px] uppercase transition-all border border-slate-200 shadow-sm">üö™ Keluar</button>
        </div>
    </div>

    <div class="container mx-auto p-6 no-print">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <div class="space-y-4">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-blue-700 uppercase mb-4 text-[10px] tracking-widest border-b pb-2">‚öôÔ∏è 1. Tetapan Sesi</h2>
                    <label class="text-[10px] font-bold text-slate-400 block mb-1 uppercase">Sesi Akademik</label>
                    <div class="flex gap-2 mb-4">
                        <select id="sesiAkademik" onchange="loadClassList()" class="flex-1 p-2 border rounded font-bold text-blue-900 bg-blue-50 text-xs focus:ring-2 focus:ring-blue-500 outline-none"></select>
                        <button onclick="addSessionToFirebase()" class="bg-blue-200 hover:bg-blue-300 text-blue-800 px-3 rounded font-bold text-lg">+</button>
                    </div>
                    
                    <label class="text-[10px] font-bold text-slate-400 block mb-1 uppercase">Jenis Pentaksiran</label>
                    <div class="flex gap-2 mb-4">
                        <select id="sesiPentaksiran" onchange="startSync()" class="flex-1 p-2 border rounded font-bold text-emerald-800 bg-emerald-50 text-xs focus:ring-2 focus:ring-emerald-500 outline-none"></select>
                        <button onclick="addAssessmentToFirebase()" class="bg-emerald-200 hover:bg-emerald-300 text-emerald-800 px-3 rounded font-bold text-lg">+</button>
                    </div>

                    <div id="class-area" class="hidden animate-fade-in">
                        <label class="text-[10px] font-bold text-slate-400 block mb-1 uppercase">Pilih Kelas</label>
                        <select id="classDropdown" onchange="startSync()" class="w-full p-2 border border-amber-300 rounded font-bold text-blue-900 bg-amber-50 text-xs focus:ring-2 focus:ring-amber-500 outline-none"></select>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-blue-700 uppercase mb-3 text-[10px] tracking-widest border-b pb-2">üì• 2. Import Murid</h2>
                    <button onclick="downloadTemplate()" class="w-full bg-slate-50 hover:bg-slate-100 text-slate-500 py-1.5 rounded text-[9px] font-bold border border-dashed border-slate-300 mb-3">‚¨áÔ∏è Templat Excel/CSV</button>
                    <input type="file" id="csvInput" accept=".csv" class="w-full text-[10px] mb-2 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-[10px] file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <button onclick="processCSV()" class="w-full bg-blue-600 text-white py-2.5 rounded text-[10px] font-bold uppercase hover:bg-blue-700 shadow-md transition-all">Proses Fail</button>
                </div>

                <div class="bg-slate-900 p-5 rounded-xl shadow-lg border border-slate-800 text-white">
                    <h2 class="font-black text-[10px] text-yellow-400 uppercase mb-3 border-b border-slate-700 pb-1 tracking-widest">üíæ Pengurusan Data</h2>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button onclick="backupCurrentData()" class="bg-slate-800 hover:bg-slate-700 py-3 rounded-lg text-[9px] font-bold border border-slate-700 flex flex-col items-center gap-1 transition-all">
                            <span class="text-base">üìÅ</span> BACKUP
                        </button>
                        <button onclick="document.getElementById('restoreInput').click()" class="bg-slate-800 hover:bg-slate-700 py-3 rounded-lg text-[9px] font-bold border border-slate-700 flex flex-col items-center gap-1 transition-all">
                            <span class="text-base">‚ôªÔ∏è</span> RESTORE
                        </button>
                        <input type="file" id="restoreInput" accept=".json" class="hidden" onchange="restoreData(this)">
                    </div>
                    <div class="space-y-2">
                        <button onclick="deleteCurrentClass()" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-400 py-2 rounded text-[9px] font-bold border border-slate-700 text-left px-3 transition-all">üóëÔ∏è Padam Kelas Dipilih</button>
                        <button onclick="deleteAllPentaksiranData()" class="w-full bg-red-950 text-red-400 py-2 rounded text-[9px] font-bold border border-red-900 text-left px-3 transition-all hover:bg-red-900">üö® RESET SEMUA DATA CLOUD</button>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="font-bold text-blue-700 uppercase text-[10px] tracking-widest border-b pb-2 flex-grow">üìö Subjek</h2>
                        <button onclick="addSubjectToFirebase()" class="text-[9px] bg-blue-50 text-blue-700 px-2 py-1 rounded font-bold hover:bg-blue-100">+ Cloud</button>
                    </div>
                    <div id="subject-grid" class="grid grid-cols-1 gap-1 max-h-48 overflow-y-auto text-[10px]"></div>
                </div>
            </div>

            <div class="lg:col-span-3 space-y-6">
                <div id="dashboard" class="grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border-l-8 border-blue-600 text-center">
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">GPM KELAS</p>
                        <p id="stat-gpm" class="text-3xl font-black text-blue-900">-</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border-l-8 border-emerald-500 text-center">
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">% LULUS</p>
                        <p id="stat-lulus" class="text-3xl font-black text-emerald-600">-</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border-l-8 border-orange-400 text-center">
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">JUMLAH MURID</p>
                        <p id="stat-murid" class="text-3xl font-black text-slate-800">-</p>
                    </div>
                    <button onclick="calculate()" class="bg-blue-900 text-white rounded-2xl font-black text-xs uppercase shadow-xl hover:bg-blue-800 transition-all hover:scale-105 active:scale-95">üöÄ JANA SIJIL & ANALISIS</button>
                </div>

                <div id="manual-add-area" class="bg-emerald-50 p-4 rounded-xl border border-emerald-100 hidden flex flex-col md:flex-row gap-2 items-center shadow-inner">
                    <span class="text-[10px] font-bold text-emerald-800 uppercase px-2">‚ûï Tambah Murid:</span>
                    <input type="text" id="newStudentName" placeholder="Nama Penuh..." class="flex-1 p-2 border rounded-lg text-xs uppercase font-black outline-none focus:ring-2 focus:ring-emerald-400">
                    <button onclick="addStudentManual()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold text-xs uppercase shadow-md hover:bg-emerald-700 transition-all">Simpan</button>
                </div>

                <div id="table-card" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden hidden">
                    <div class="p-4 bg-slate-50 border-b flex items-center gap-3">
                        <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="Cari nama murid..." class="flex-1 p-2 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-xs font-bold">
                        <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold text-[10px] shadow hover:bg-emerald-700 transition-all">üìä EKSPORT EXCEL</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-blue-900 text-white text-[9px] uppercase tracking-wider">
                                <tr id="tableHeader"></tr>
                            </thead>
                            <tbody id="tableBody" class="text-[11px] font-medium"></tbody>
                        </table>
                    </div>
                </div>

                <div id="excellence-panel" class="hidden">
                    <div class="bg-white p-5 rounded-xl border-t-4 border-emerald-500 shadow-sm">
                        <h3 class="font-black text-emerald-700 text-[10px] mb-3 border-b pb-2 uppercase tracking-widest flex items-center gap-2">üèÜ Kedudukan Tertinggi (GPM)</h3>
                        <div id="top-5-list" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div>
                    </div>
                </div>

                <div id="print-btn-area" class="hidden flex justify-center pb-20">
                    <button onclick="window.print()" class="bg-blue-900 text-white px-12 py-4 rounded-full font-black text-lg shadow-2xl hover:scale-105 transition-all hover:bg-blue-800">üñ®Ô∏è CETAK SEMUA SIJIL</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="section-sijil"></div>

<script>
    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyCwh99Ui4KPXgC-W-CpCg-edYnHN3aVmrk", 
        authDomain: "portal-8368.firebaseapp.com",
        projectId: "portal-8368",
        storageBucket: "portal-8368.firebasestorage.app",
        messagingSenderId: "150403488308",
        appId: "1:150403488308:web:fac9b3c52dcd9975130861"
    };

    const BASE_EXAMS = [
        {id: 'UASA', name: 'UASA'},
        {id: 'PPT', name: 'PERTENGAHAN TAHUN'},
        {id: 'UB1', name: 'UJIAN BULANAN 1'}
    ];

    const BASE_SUBJECTS = [
        {id:'BM', name:'BAHASA MELAYU'}, {id:'BI', name:'BAHASA INGGERIS'}, {id:'MT', name:'MATEMATIK'}, 
        {id:'SN', name:'SAINS'}, {id:'SJ', name:'SEJARAH'}, {id:'PAI', name:'PENDIDIKAN ISLAM'}
    ];

    let ALL_SUBJECTS = [];
    let db, auth, currentClassData = [], selectedSubjects = [];

    window.onload = () => { 
        firebase.initializeApp(firebaseConfig); 
        db = firebase.firestore(); 
        auth = firebase.auth(); 
        initAuthCheck(); 
    };

    function showToast(msg, type = 'success') {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        el.className = `toast ${type === 'error' ? 'bg-red-600' : 'bg-emerald-600'}`;
        el.innerText = msg;
        container.appendChild(el);
        setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
    }

    // ==========================================
    // SISTEM LOGIN (GOOGLE DELIMA V13.0)
    // ==========================================
    
    function initAuthCheck() {
        auth.onAuthStateChanged((user) => {
            if (user) {
                const email = user.email.toLowerCase();
                // Filter: Hanya GURU/STAF DELIMa
                if (email.startsWith('g-') || email.endsWith('@moe.edu.my')) {
                    document.getElementById('auth-overlay').style.display = 'none';
                    document.getElementById('main-content').classList.remove('hidden');
                    document.getElementById('user-welcome').innerText = `GURU: ${email}`;
                    initSystemData();
                } else {
                    const errorBox = document.getElementById('login-error');
                    errorBox.innerText = "AKSES DISEKAT: Anda login menggunakan akaun murid. Sila gunakan akaun GURU rasmi.";
                    errorBox.classList.remove('hidden');
                    auth.signOut();
                    showLoginUI();
                }
            } else {
                showLoginUI();
            }
        });
    }

    function showLoginUI() {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('login-state').classList.remove('hidden');
        document.getElementById('main-content').classList.add('hidden');
        document.getElementById('auth-overlay').style.display = 'flex';
    }

    function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(err => {
            const errorBox = document.getElementById('login-error');
            errorBox.innerText = "Ralat: " + err.message;
            errorBox.classList.remove('hidden');
        });
    }

    function logoutSystem() { auth.signOut().then(() => location.reload()); }

    // ==========================================
    // CORE SYSTEM FUNCTIONS (700 LINES LOGIC)
    // ==========================================

    async function initSystemData() {
        try {
            const sesiSelect = document.getElementById('sesiAkademik');
            const sesiSnap = await db.collection('sesi').get();
            let availableSesi = sesiSnap.empty ? ['2025'] : sesiSnap.docs.map(doc => doc.id).sort();
            sesiSelect.innerHTML = availableSesi.map(s => `<option value="${s}">${s}</option>`).join('');
            
            // Load Exams from global settings
            const examRef = db.collection('_tetapan_sistem').doc('senarai_pentaksiran');
            const examSnap = await examRef.get();
            let examList = examSnap.exists ? examSnap.data().exams : BASE_EXAMS;
            document.getElementById('sesiPentaksiran').innerHTML = examList.map(j => `<option value="${j.id}">${j.name}</option>`).join('');

            // Load Subjects from global settings
            const subRef = db.collection('_tetapan_sistem').doc('senarai_subjek');
            const subSnap = await subRef.get();
            let extraSubjects = subSnap.exists ? subSnap.data().subjects : [];
            ALL_SUBJECTS = [...BASE_SUBJECTS];
            extraSubjects.forEach(s => { if(!ALL_SUBJECTS.find(k => k.id === s.id)) ALL_SUBJECTS.push(s); });

            renderSubjectGrid();
            loadClassList();
        } catch (e) { showToast("Gagal memuatkan data Cloud.", "error"); }
    }

    async function addSessionToFirebase() {
        const input = prompt("Tahun Sesi Akademik Baru (Contoh: 2026):");
        if (!input) return;
        await db.collection('sesi').doc(input).set({ created: true });
        initSystemData();
        showToast("Sesi baru ditambah!");
    }

    async function addAssessmentToFirebase() {
        const name = prompt("Nama Pentaksiran Baru (Contoh: UJIAN 1):");
        if (!name) return;
        const id = name.toUpperCase().replace(/\s+/g, '_');
        await db.collection('_tetapan_sistem').doc('senarai_pentaksiran').update({
            exams: firebase.firestore.FieldValue.arrayUnion({ id: id, name: name.toUpperCase() })
        }).catch(async () => {
            await db.collection('_tetapan_sistem').doc('senarai_pentaksiran').set({ exams: [{id: id, name: name.toUpperCase()}] });
        });
        initSystemData();
        showToast("Ujian baru ditambah secara global!");
    }

    async function addSubjectToFirebase() {
        const name = prompt("Nama Matapelajaran Baru:");
        if (!name) return;
        const id = name.substring(0,3).toUpperCase() + Math.floor(Math.random()*100);
        await db.collection('_tetapan_sistem').doc('senarai_subjek').update({
            subjects: firebase.firestore.FieldValue.arrayUnion({ id: id, name: name.toUpperCase() })
        }).catch(async () => {
            await db.collection('_tetapan_sistem').doc('senarai_subjek').set({ subjects: [{id: id, name: name.toUpperCase()}] });
        });
        initSystemData();
        showToast("Subjek ditambah!");
    }

    function renderSubjectGrid() {
        const grid = document.getElementById('subject-grid'); grid.innerHTML = '';
        ALL_SUBJECTS.forEach(sub => {
            const isChecked = ['BM','BI','MT','SN','SJ','PAI'].includes(sub.id) ? 'checked' : '';
            grid.innerHTML += `
                <label class="flex items-center space-x-3 p-2 hover:bg-slate-50 cursor-pointer rounded border border-transparent hover:border-slate-100 transition-all">
                    <input type="checkbox" value="${sub.id}" class="sub-checkbox w-4 h-4 rounded text-blue-900 focus:ring-blue-900" ${isChecked} onchange="updateSelectedSubjects()"> 
                    <span class="font-bold text-slate-700">${sub.name}</span>
                </label>`;
        });
        updateSelectedSubjects();
    }

    function updateSelectedSubjects() { 
        selectedSubjects = Array.from(document.querySelectorAll('.sub-checkbox:checked')).map(cb => cb.value); 
        if(currentClassData.length > 0) renderTable();
    }

    async function loadClassList() {
        const sesi = document.getElementById('sesiAkademik').value;
        const snap = await db.collection('sesi').doc(sesi).collection('kelas').get();
        document.getElementById('classDropdown').innerHTML = '<option value="">-- Pilih Kelas --</option>' + snap.docs.map(d => `<option value="${d.id}">${d.data().nama_kelas || d.id}</option>`).join('');
        document.getElementById('class-area').classList.remove('hidden');
    }

    function startSync() {
        const sesi = document.getElementById('sesiAkademik').value, jenis = document.getElementById('sesiPentaksiran').value, kelas = document.getElementById('classDropdown').value;
        if(!kelas) return;
        document.getElementById('manual-add-area').classList.remove('hidden');
        db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(kelas).collection('murid')
          .onSnapshot(snap => { currentClassData = snap.docs.map(d => ({id: d.id, ...d.data()})); renderTable(); });
    }

    async function updateMark(sid, sub, val) {
        const sesi = document.getElementById('sesiAkademik').value, jenis = document.getElementById('sesiPentaksiran').value, kelas = document.getElementById('classDropdown').value;
        let c = parseFloat(val); if(isNaN(c)) c=0;
        await db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(kelas).collection('murid').doc(sid).set({ marks: {[sub]: c} }, {merge: true});
    }

    async function addStudentManual() {
        const nama = document.getElementById('newStudentName').value.toUpperCase().trim();
        const sesi = document.getElementById('sesiAkademik').value, jenis = document.getElementById('sesiPentaksiran').value, kelas = document.getElementById('classDropdown').value;
        if(!nama || !kelas) return;
        await db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(kelas).collection('murid').add({ nama: nama, marks: {} });
        document.getElementById('newStudentName').value = '';
    }

    async function deleteStudent(sid) {
        if(!confirm("Padam data murid ini secara kekal?")) return;
        const sesi = document.getElementById('sesiAkademik').value, jenis = document.getElementById('sesiPentaksiran').value, kelas = document.getElementById('classDropdown').value;
        await db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(kelas).collection('murid').doc(sid).delete();
    }

    async function deleteCurrentClass() {
        const kelas = document.getElementById('classDropdown').value;
        if(!kelas) return;
        if(!confirm("Padam SELURUH murid dalam kelas ini?")) return;
        const sesi = document.getElementById('sesiAkademik').value, jenis = document.getElementById('sesiPentaksiran').value;
        const snap = await db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(kelas).collection('murid').get();
        let batch = db.batch();
        snap.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        showToast("Satu kelas telah dikosongkan.");
    }

    async function deleteAllPentaksiranData() {
        const code = Math.floor(1000 + Math.random() * 9000);
        const confirmation = prompt(`AMARAN! Anda akan memadam SEMUA DATA CLOUD. Sila taip kod ini untuk sahkan: ${code}`);
        if(confirmation !== code.toString()) return;
        
        showToast("Memadam data pangkalan data...", "error");
        // Logik memadam koleksi memerlukan fungsi rekursif atau Cloud Function, 
        // di sini kita buat pemadaman rekod kelas secara manual melalui Batch.
        const sesi = document.getElementById('sesiAkademik').value;
        const kelasSnap = await db.collection('sesi').doc(sesi).collection('kelas').get();
        for(const kDoc of kelasSnap.docs) {
             const jenis = document.getElementById('sesiPentaksiran').value;
             const mSnap = await db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(kDoc.id).collection('murid').get();
             let batch = db.batch();
             mSnap.forEach(m => batch.delete(m.ref));
             await batch.commit();
        }
        location.reload();
    }

    function renderTable() {
        const search = document.getElementById('searchInput').value.toUpperCase();
        const header = document.getElementById('tableHeader');
        header.innerHTML = `<th class="p-4 bg-blue-900 sticky left-0 z-10 min-w-[200px]">NAMA MURID</th>` + 
            selectedSubjects.map(s => `<th class="p-2 text-center bg-blue-800 border-x border-blue-700 min-w-[60px]">${s}</th>`).join('') + 
            `<th class="p-2 text-center bg-slate-700 min-w-[60px]">GPM</th><th class="p-2 text-center bg-red-900 w-[50px]">X</th>`;
        
        const sorted = [...currentClassData].filter(m => m.nama.includes(search)).sort((a,b) => a.nama.localeCompare(b.nama));
        document.getElementById('tableBody').innerHTML = sorted.map(m => `
            <tr class="border-b hover:bg-blue-50 transition-colors">
                <td class="p-4 font-black uppercase text-slate-700 bg-white sticky left-0 shadow-inner">${m.nama}</td>
                ${selectedSubjects.map(sub => `<td class="p-1 text-center"><input type="number" class="mark-input" value="${m.marks?.[sub] ?? ''}" onchange="updateMark('${m.id}', '${sub}', this.value)"></td>`).join('')}
                <td class="p-2 text-center font-black text-blue-600 bg-slate-50">${m.gpm || '-'}</td>
                <td class="p-2 text-center"><button onclick="deleteStudent('${m.id}')" class="text-red-300 hover:text-red-600 transition-colors">üóëÔ∏è</button></td>
            </tr>`).join('');
        document.getElementById('table-card').classList.remove('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('stat-murid').innerText = currentClassData.length;
    }

    function calculate() {
        const getGrade = (m) => { 
            m=parseFloat(m)||0; 
            if(m>=80)return{g:'A',p:1}; if(m>=70)return{g:'B',p:2}; if(m>=60)return{g:'C',p:3}; 
            if(m>=50)return{g:'D',p:4}; if(m>=40)return{g:'E',p:5}; return{g:'F',p:6}; 
        };
        let totalPass=0;
        currentClassData.forEach(s => {
            let tm=0, tp=0, count=0, l=true;
            selectedSubjects.forEach(sub => { 
                let m=s.marks?.[sub]; 
                if(m!==undefined&&m!==""){ 
                    m=parseFloat(m); let r=getGrade(m); tm+=m; tp+=r.p; count++; 
                    if(['BM','BI','MT','SN','SJ','PAI'].includes(sub)&&m<40)l=false; 
                } 
            });
            s.gpm = count>0?(tp/count).toFixed(2):'0.00'; 
            s.percent=count>0?((tm/(count*100))*100).toFixed(1):'0.0'; 
            s.statusLulus=(count>0&&l)?"LULUS":"GAGAL"; 
            if(s.statusLulus==="LULUS")totalPass++; 
            s.totalMarks=tm;
        });
        
        const sorted = [...currentClassData].sort((a,b)=>parseFloat(a.gpm)-parseFloat(b.gpm)||b.totalMarks-a.totalMarks);
        currentClassData.forEach(s => s.rank = sorted.findIndex(r => r.id === s.id) + 1);
        
        document.getElementById('stat-gpm').innerText = (currentClassData.reduce((a,b)=>a+parseFloat(b.gpm||0),0)/(currentClassData.length||1)).toFixed(2);
        document.getElementById('stat-lulus').innerText = ((totalPass/(currentClassData.length||1))*100).toFixed(1)+"%";
        document.getElementById('top-5-list').innerHTML = sorted.slice(0,5).map((s,i) => `
            <div class="flex justify-between items-center p-3 border border-slate-100 rounded-xl bg-slate-50">
                <span class="font-bold text-slate-700">${i+1}. ${s.nama}</span>
                <span class="bg-emerald-600 text-white px-3 py-1 rounded-full font-black text-[10px]">GPM: ${s.gpm}</span>
            </div>`).join('');
        
        document.getElementById('excellence-panel').classList.remove('hidden'); 
        document.getElementById('print-btn-area').classList.remove('hidden');
        renderTable(); 
        generateSijil(getGrade); 
        showToast("Analisis Cloud Berjaya!");
    }

    function generateSijil(getGrade) {
        const pentaksiran = document.getElementById('sesiPentaksiran').options[document.getElementById('sesiPentaksiran').selectedIndex].text;
        const sesi = document.getElementById('sesiAkademik').value;
        document.getElementById('section-sijil').innerHTML = currentClassData.sort((a,b)=>a.nama.localeCompare(b.nama)).map(s => `
            <div class="page-break"><div class="certificate-border">
                <div class="text-center">
                    <img src="myeasy.png" class="h-16 mx-auto mb-4">
                    <h2 class="text-2xl font-black text-blue-900 uppercase tracking-tighter">SK ABANG GESA, BELAWAI</h2>
                    <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">${pentaksiran} (${sesi})</p>
                </div>
                <div class="text-center">
                    <h1 style="font-family: 'Cinzel', serif;" class="text-5xl font-bold text-blue-900">SIJIL PENCAPAIAN</h1>
                    <p class="mt-4 italic text-sm text-slate-500">Dianugerahkan kepada</p>
                    <h2 class="text-3xl font-black my-6 uppercase text-blue-950 border-b-4 border-blue-900 inline-block px-12 pb-2 leading-none">${s.nama}</h2>
                </div>
                <div class="flex justify-center flex-grow py-6">
                    <table class="w-11/12 border-2 border-slate-800 text-[11px]">
                        <thead class="bg-blue-900 text-white uppercase text-sm font-black">
                            <tr><th class="p-3 border-2 border-slate-800 text-left">MATAPELAJARAN</th><th class="p-3 border-2 border-slate-800 text-center">MARKAH</th><th class="p-3 border-2 border-slate-800 text-center">GRED</th></tr>
                        </thead>
                        <tbody class="font-bold">
                            ${selectedSubjects.map(sub => { 
                                let m=s.marks?.[sub]; 
                                if(m===undefined||m==="")return""; 
                                return `<tr>
                                    <td class="border-2 border-slate-800 p-2.5 px-6 uppercase text-slate-700">${ALL_SUBJECTS.find(k=>k.id===sub)?.name||sub}</td>
                                    <td class="border-2 border-slate-800 text-center p-2.5 text-base font-black">${m}</td>
                                    <td class="border-2 border-slate-800 text-center p-2.5 text-base font-black text-blue-900">${getGrade(m).g}</td>
                                </tr>`; 
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="grid grid-cols-4 gap-4 text-center max-w-3xl mx-auto font-black text-xs w-full">
                    <div class="bg-slate-50 p-3 border-2 border-slate-200 rounded-xl">GPM: ${s.gpm}</div>
                    <div class="bg-slate-50 p-3 border-2 border-slate-200 rounded-xl uppercase">RANK: ${s.rank}</div>
                    <div class="bg-blue-900 text-white p-3 rounded-xl uppercase shadow-lg">${s.statusLulus}</div>
                    <div class="bg-slate-50 p-3 border-2 border-slate-200 rounded-xl">${s.percent}%</div>
                </div>
                <div class="mt-12 flex justify-between px-16 text-xs font-black text-center uppercase">
                    <div class="w-56"><div class="border-b-2 border-black h-12 mb-2"></div><p>Guru Kelas</p></div>
                    <div class="w-56"><div class="border-b-2 border-black h-12 mb-2"></div><p>Guru Besar</p></div>
                </div>
            </div></div>`).join('');
    }

    async function backupCurrentData() {
        const sesi = document.getElementById('sesiAkademik').value;
        const jenis = document.getElementById('sesiPentaksiran').value;
        showToast("Sedang menjana fail backup...");
        const masterSnap = await db.collection('sesi').doc(sesi).collection('kelas').get();
        let backupData = { meta: { sesi, jenis }, content: [] };
        for(const doc of masterSnap.docs) {
            const mSnap = await db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(doc.id).collection('murid').get();
            backupData.content.push({ classID: doc.id, className: doc.data().nama_kelas, students: mSnap.docs.map(m => m.data()) });
        }
        const blob = new Blob([JSON.stringify(backupData)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `SKAG_BACKUP_${sesi}.json`; a.click();
    }

    async function restoreData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = JSON.parse(e.target.result);
            showToast("Memulihkan data ke Cloud...");
            for(const item of data.content) {
                const cRef = db.collection('sesi').doc(data.meta.sesi).collection('pentaksiran').doc(data.meta.jenis).collection('kelas').doc(item.classID);
                await db.collection('sesi').doc(data.meta.sesi).collection('kelas').doc(item.classID).set({nama_kelas: item.className});
                let batch = db.batch();
                item.students.forEach(std => { batch.set(cRef.collection('murid').doc(), std); });
                await batch.commit();
            }
            showToast("Restore Selesai!"); location.reload();
        };
        reader.readAsText(file);
    }

    function downloadTemplate() { 
        const wb = XLSX.utils.book_new(); 
        const ws = XLSX.utils.aoa_to_sheet([["NAMA", "KELAS"]]); 
        XLSX.utils.book_append_sheet(wb, ws, "Templat"); 
        XLSX.writeFile(wb, "Templat_Import_SKAG.xlsx"); 
    }

    async function processCSV() {
        const file = document.getElementById('csvInput').files[0], sesi = document.getElementById('sesiAkademik').value, jenis = document.getElementById('sesiPentaksiran').value;
        if (!file) { showToast("Sila pilih fail CSV", "error"); return; }
        Papa.parse(file, { header: true, skipEmptyLines: true, complete: async (res) => {
            for (const row of res.data) {
                const d = Object.keys(row).reduce((acc, k) => { acc[k.toLowerCase().trim()] = row[k]; return acc; }, {});
                if (d.nama && d.kelas) {
                    const cid = d.kelas.toString().toUpperCase().trim().replace(/[^a-zA-Z0-9]/g,'_');
                    await db.collection('sesi').doc(sesi).collection('kelas').doc(cid).set({ nama_kelas: d.kelas.toUpperCase() }, {merge:true});
                    await db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(cid).collection('murid').add({ nama: d.nama.toUpperCase().trim(), marks: {} });
                }
            }
            showToast("Pukal import selesai!"); loadClassList();
        }});
    }

    function exportToExcel() {
        const data = currentClassData.map(m => ({ Nama: m.nama, ...m.marks, GPM: m.gpm, Status: m.statusLulus }));
        const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Analisis"); XLSX.writeFile(wb, `Analisis_SKAG_${new Date().toLocaleDateString()}.xlsx`);
    }
</script>
</body>
</html>
