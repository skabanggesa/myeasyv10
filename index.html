<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Analisis SKAG V10.5 - Data Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Great+Vibes&display=swap');
        
        @media print {
            body * { visibility: hidden; }
            #section-sijil, #section-sijil * { visibility: visible; }
            #section-sijil { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .page-break { page-break-after: always; break-after: page; display: block; height: 100vh; position: relative; }
        }

        .certificate-border { 
            border: 20px double #1e3a8a; 
            padding: 40px; 
            background: white; 
            height: 98vh; 
            box-sizing: border-box;
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
        }

        .mark-input { width: 50px; padding: 4px; text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; font-weight: bold; }
        .mark-input:invalid { border-color: red; background-color: #fee2e2; }

        #auth-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 8px; color: white; font-weight: bold; font-size: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800 text-sm">

<div id="toast-container"></div>

<div id="auth-overlay">
    <div id="loading-state" class="text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-900 mb-4 mx-auto"></div>
        <p class="font-bold text-blue-900 animate-pulse">MENYEMAK STATUS...</p>
    </div>
    <div id="login-state" class="hidden text-center bg-white p-8 rounded-2xl shadow-2xl border border-slate-200 max-w-sm w-full mx-4">
        <h2 class="text-2xl font-black text-blue-900 mb-2">SISTEM ANALISIS SKAG</h2>
        <div class="space-y-4 text-left">
            <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Emel</label><input type="email" id="emailInput" class="w-full p-3 border rounded-lg"></div>
            <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Kata Laluan</label><input type="password" id="passwordInput" class="w-full p-3 border rounded-lg"></div>
            <p id="login-error" class="text-red-600 text-xs font-bold text-center hidden"></p>
            <button onclick="loginWithEmail()" id="btnLogin" class="w-full bg-blue-900 text-white font-bold py-3 rounded-xl">LOG MASUK</button>
        </div>
    </div>
</div>

<div id="main-content" class="hidden">
    <div class="bg-white p-5 shadow-sm border-b-4 border-blue-900 no-print">
        <div class="container mx-auto flex justify-between items-center gap-4">
            <div><h1 class="text-xl font-black text-blue-900 uppercase">SK ABANG GESA, BELAWAI</h1><p id="user-welcome" class="text-[10px] font-bold text-blue-500 uppercase">...</p></div>
            <button onclick="logoutSystem()" class="bg-red-600 text-white px-5 py-2 rounded-lg font-bold text-xs uppercase">üö™ Log Keluar</button>
        </div>
    </div>

    <div class="container mx-auto p-6 no-print">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <div class="space-y-4">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-xs text-blue-700 uppercase mb-4 text-[10px]">‚öôÔ∏è 1. Tetapan Sesi</h2>
                    <label class="text-[10px] font-bold text-slate-400 block mb-1">SESI AKADEMIK</label>
                    <select id="sesiAkademik" onchange="loadClassList()" class="w-full p-2 border rounded font-bold text-blue-900 mb-4 bg-blue-50">
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                    
                    <label class="text-[10px] font-bold text-slate-400 block mb-1">JENIS PENTAKSIRAN</label>
                    <select id="sesiPentaksiran" onchange="startSync()" class="w-full p-2 border rounded font-bold text-emerald-800 mb-4 bg-emerald-50">
                        <option value="Ujian_Akhir_Sesi_Akademik_(UASA)">UASA</option>
                        <option value="Pentaksiran_Pertengahan_Tahun">PERTENGAHAN TAHUN</option>
                        <option value="Ujian_Bulanan_1">UJIAN BULANAN 1</option>
                    </select>

                    <div id="class-area" class="hidden">
                        <label class="text-[10px] font-bold text-slate-400 block mb-1">PILIH KELAS</label>
                        <select id="classDropdown" onchange="startSync()" class="w-full p-2 border border-amber-300 rounded font-bold text-blue-900 bg-amber-50"></select>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-xs text-blue-700 uppercase mb-3 text-[10px]">üì• 2. Import CSV (Pukal)</h2>
                    <div class="flex gap-2 mb-2">
                        <button onclick="downloadTemplate()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-600 py-1 rounded text-[9px] font-bold border border-slate-300">‚¨áÔ∏è Templat CSV</button>
                    </div>
                    <input type="file" id="csvInput" accept=".csv" class="w-full text-[10px] mb-2">
                    <button onclick="processCSV()" class="w-full bg-blue-600 text-white py-2 rounded text-[10px] font-bold uppercase hover:bg-blue-700">Proses Fail CSV</button>
                </div>

                <div class="bg-slate-800 p-5 rounded-xl shadow-lg border text-white">
                    <h2 class="font-black text-[10px] text-yellow-400 uppercase mb-3 border-b border-slate-600 pb-1">üíæ PENGURUSAN DATA (ADVANCED)</h2>
                    
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button onclick="backupCurrentData()" class="bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg text-[10px] font-bold flex flex-col items-center justify-center gap-1">
                            <span class="text-lg">üíæ</span>
                            <span>BACKUP</span>
                        </button>
                        
                        <button onclick="document.getElementById('restoreInput').click()" class="bg-sky-600 hover:bg-sky-500 text-white py-3 rounded-lg text-[10px] font-bold flex flex-col items-center justify-center gap-1">
                            <span class="text-lg">‚ôªÔ∏è</span>
                            <span>RESTORE</span>
                        </button>
                        <input type="file" id="restoreInput" accept=".json" class="hidden" onchange="restoreData(this)">
                    </div>

                    <div class="space-y-2 border-t border-slate-600 pt-3">
                        <p class="text-[9px] text-red-300 font-bold uppercase">Zon Bahaya:</p>
                        <button onclick="deleteCurrentClass()" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-2 rounded text-[9px] font-bold border border-slate-600 text-left px-3">üóëÔ∏è Padam Kelas Ini Sahaja</button>
                        <button onclick="deleteAllPentaksiranData()" class="w-full bg-red-900 hover:bg-red-800 text-white py-2 rounded text-[9px] font-bold border border-red-700 text-left px-3">üö® Padam SEMUA Data (Reset)</button>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="font-bold text-xs text-blue-700 uppercase text-[10px]">üìö Matapelajaran</h2>
                        <button onclick="addCustomSubject()" class="text-[9px] bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200 font-bold">+ Tambah</button>
                    </div>
                    <div id="subject-grid" class="grid grid-cols-1 gap-1 max-h-48 overflow-y-auto text-[10px]"></div>
                </div>
            </div>

            <div class="lg:col-span-3 space-y-6">
                
                <div id="dashboard" class="grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border-l-8 border-blue-600 text-center"><p class="text-[10px] font-bold text-slate-400">GPM KELAS</p><p id="stat-gpm" class="text-3xl font-black text-blue-900">-</p></div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border-l-8 border-emerald-500 text-center"><p class="text-[10px] font-bold text-slate-400">% LULUS</p><p id="stat-lulus" class="text-3xl font-black text-emerald-600">-</p></div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border-l-8 border-orange-400 text-center"><p class="text-[10px] font-bold text-slate-400">BIL. MURID</p><p id="stat-murid" class="text-3xl font-black text-slate-800">-</p></div>
                    <button onclick="calculate()" class="bg-blue-900 text-white rounded-2xl font-black text-sm uppercase shadow-xl hover:scale-105 transition">üöÄ JANA SIJIL & ANALISIS</button>
                </div>

                <div id="manual-add-area" class="bg-green-50 p-4 rounded-xl border border-green-200 hidden flex flex-col md:flex-row gap-2 items-center">
                    <span class="text-xs font-bold text-green-800 uppercase whitespace-nowrap">‚ûï Tambah Murid Baru:</span>
                    <input type="text" id="newStudentName" placeholder="Nama Penuh Murid..." class="flex-1 p-2 border rounded text-xs uppercase font-bold">
                    <button onclick="addStudentManual()" class="bg-green-600 text-white px-4 py-2 rounded font-bold text-xs uppercase hover:bg-green-700">Simpan</button>
                </div>

                <div id="table-card" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden hidden">
                    <div class="p-4 bg-slate-50 border-b flex items-center gap-3">
                        <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="Cari nama murid..." class="flex-1 p-2 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-6 py-2 rounded-xl font-bold text-xs">üìä EXCEL</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-blue-900 text-white text-[10px] uppercase"><tr id="tableHeader"></tr></thead>
                            <tbody id="tableBody" class="text-xs"></tbody>
                        </table>
                    </div>
                </div>

                <div id="excellence-panel" class="hidden space-y-4">
                    <div class="bg-white p-5 rounded-xl border-t-4 border-emerald-500 shadow-sm"><h3 class="font-black text-emerald-700 text-xs mb-3 border-b pb-2">üèÜ TOP 5 PELAJAR</h3><div id="top-5-list"></div></div>
                </div>
                <div id="print-btn-area" class="hidden flex justify-center pb-24"><button onclick="window.print()" class="bg-blue-900 text-white px-16 py-5 rounded-full font-black text-xl shadow-2xl">üñ®Ô∏è CETAK SEMUA SIJIL</button></div>
            </div>
        </div>
    </div>
</div>
<div id="section-sijil"></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCwh99Ui4KPXgC-W-CpCg-edYnHN3aVmrk", 
        authDomain: "portal-8368.firebaseapp.com",
        projectId: "portal-8368",
        storageBucket: "portal-8368.firebasestorage.app",
        messagingSenderId: "150403488308",
        appId: "1:150403488308:web:fac9b3c52dcd9975130861"
    };

    let KPM_SUBJECTS = [
        {id:'BM', name:'BAHASA MELAYU'}, {id:'BI', name:'BAHASA INGGERIS'}, {id:'MT', name:'MATEMATIK'}, 
        {id:'SN', name:'SAINS'}, {id:'SJ', name:'SEJARAH'}, {id:'PAI', name:'PENDIDIKAN ISLAM'},
        {id:'BA', name:'BAHASA ARAB'}, {id:'MZ', name:'PENDIDIKAN MUZIK'}, 
        {id:'PJK', name:'PENDIDIKAN JASMANI'}, {id:'PSV', name:'PENDIDIKAN SENI VISUAL'}, 
        {id:'RBT', name:'REKA BENTUK TEKNOLOGI'}, {id:'MORAL', name:'PENDIDIKAN MORAL'}
    ];

    let db, auth, currentClassData = [], selectedSubjects = [];

    window.onload = () => { 
        firebase.initializeApp(firebaseConfig); 
        db = firebase.firestore(); 
        auth = firebase.auth(); 
        loadCustomSubjects(); 
        renderSubjectGrid(); 
        initAuthCheck(); 
        document.getElementById("passwordInput").addEventListener("keypress", (e) => { if(e.key==="Enter") document.getElementById("btnLogin").click(); });
    };

    function showToast(msg, type = 'success') {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        el.className = `toast ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
        el.innerText = msg;
        container.appendChild(el);
        setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
    }

    // --- DATA MANAGER FUNCTIONS (NEW) ---

    // 1. BACKUP DATA (Export JSON)
    async function backupCurrentData() {
        const sesi = document.getElementById('sesiAkademik').value;
        const jenisID = document.getElementById('sesiPentaksiran').value;
        const sel = document.getElementById('sesiPentaksiran');
        const jenisNama = sel.options[sel.selectedIndex].text;

        showToast("Sedang membuat backup data...", "normal");

        try {
            const rootRef = db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenisID).collection('kelas');
            const kelasSnap = await rootRef.get();
            
            if(kelasSnap.empty) return showToast("Tiada data untuk di-backup.", "error");

            let exportObj = {
                meta: {
                    sesi: sesi,
                    pentaksiran_id: jenisID,
                    pentaksiran_nama: jenisNama,
                    tarikh_backup: new Date().toISOString()
                },
                data: []
            };

            for(const docKelas of kelasSnap.docs) {
                const muridSnap = await docKelas.ref.collection('murid').get();
                // Dapatkan nama kelas sebenar dari koleksi meta kelas jika ada, atau guna ID
                const kelasMetaRef = db.collection('sesi').doc(sesi).collection('kelas').doc(docKelas.id);
                const kelasMeta = await kelasMetaRef.get();
                const namaKelas = kelasMeta.exists ? kelasMeta.data().nama_kelas : docKelas.id;

                let students = muridSnap.docs.map(m => ({
                    nama: m.data().nama,
                    marks: m.data().marks
                }));

                exportObj.data.push({
                    kelas_id: docKelas.id,
                    nama_kelas: namaKelas,
                    murid: students
                });
            }

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `BACKUP_${jenisID}_${sesi}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            showToast("Backup berjaya dimuat turun!");

        } catch(e) {
            console.error(e);
            showToast("Ralat Backup: " + e.message, "error");
        }
    }

    // 2. RESTORE DATA (Import JSON)
    async function restoreData(inputElement) {
        const file = inputElement.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const json = JSON.parse(e.target.result);
                
                // Validasi ringkas
                if(!json.meta || !json.data) return showToast("Format fail backup tidak sah.", "error");

                // Konfirmasi
                if(!confirm(`Pulihkan data untuk:\nSesi: ${json.meta.sesi}\nUjian: ${json.meta.pentaksiran_nama}\n\nIni akan menggabungkan data sedia ada.`)) {
                    inputElement.value = '';
                    return;
                }

                showToast("Memulihkan data...", "normal");

                const sesi = json.meta.sesi;
                const jenis = json.meta.pentaksiran_id;
                
                // Batch processing untuk restore
                const BATCH_SIZE = 400;
                let currentBatch = db.batch();
                let opCount = 0;

                for (const kelasData of json.data) {
                    const cid = kelasData.kelas_id;
                    
                    // Restore Nama Kelas (Meta)
                    const cRefMeta = db.collection('sesi').doc(sesi).collection('kelas').doc(cid);
                    currentBatch.set(cRefMeta, { nama_kelas: kelasData.nama_kelas }, { merge: true });
                    opCount++;

                    // Create dummy doc for Class inside Pentaksiran to ensure it exists
                    const cRefPen = db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(cid);
                    currentBatch.set(cRefPen, { active: true }, { merge: true });
                    opCount++;

                    // Restore Murid
                    for (const m of kelasData.murid) {
                        const mRef = cRefPen.collection('murid').doc(); // Auto-ID baru untuk elak conflict ID lama
                        currentBatch.set(mRef, { nama: m.nama, marks: m.marks });
                        opCount++;

                        if(opCount >= BATCH_SIZE) {
                            await currentBatch.commit();
                            currentBatch = db.batch();
                            opCount = 0;
                        }
                    }
                }

                if(opCount > 0) await currentBatch.commit();

                showToast("Data berjaya dipulihkan!");
                inputElement.value = ''; // Reset input
                
                // Refresh view jika kita berada di sesi/tahun yang sama
                if(document.getElementById('sesiAkademik').value == sesi && 
                   document.getElementById('sesiPentaksiran').value == jenis) {
                    loadClassList();
                } else {
                    alert("Data dipulihkan ke Sesi " + sesi + ". Sila tukar tetapan untuk melihat data.");
                }

            } catch (err) {
                console.error(err);
                showToast("Ralat Restore: " + err.message, "error");
            }
        };
        reader.readAsText(file);
    }

    // --- END DATA MANAGER ---

    function loadCustomSubjects() {
        const custom = localStorage.getItem('customSubjects');
        if (custom) {
            const parsed = JSON.parse(custom);
            parsed.forEach(s => {
                if(!KPM_SUBJECTS.find(k => k.id === s.id)) KPM_SUBJECTS.push(s);
            });
        }
    }

    function addCustomSubject() {
        const name = prompt("Masukkan nama matapelajaran baru (Contoh: JAWI):");
        if (!name) return;
        const id = name.substring(0, 4).toUpperCase().replace(/\s/g, '');
        const newSub = { id: id, name: name.toUpperCase() };
        
        KPM_SUBJECTS.push(newSub);
        let custom = JSON.parse(localStorage.getItem('customSubjects') || "[]");
        custom.push(newSub);
        localStorage.setItem('customSubjects', JSON.stringify(custom));
        renderSubjectGrid();
        showToast(`Subjek ${name} ditambah!`);
    }

    function downloadTemplate() {
        const wb = XLSX.utils.book_new();
        const wsData = [["NAMA", "KELAS"]]; 
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "Templat");
        XLSX.writeFile(wb, "Templat_Murid.xlsx");
    }

    function initAuthCheck() {
        auth.onAuthStateChanged((user) => {
            const overlay = document.getElementById('auth-overlay');
            const main = document.getElementById('main-content');
            if (user) {
                overlay.style.display = 'none';
                main.classList.remove('hidden');
                document.getElementById('user-welcome').innerText = `Admin: ${user.email}`;
                loadClassList();
            } else {
                overlay.style.display = 'flex';
                main.classList.add('hidden');
                document.getElementById('login-state').classList.remove('hidden');
                document.getElementById('loading-state').classList.add('hidden');
            }
        });
    }

    function loginWithEmail() {
        const e = document.getElementById('emailInput').value;
        const p = document.getElementById('passwordInput').value;
        const err = document.getElementById('login-error');
        if(!e || !p) return err.innerText = "Isi semua ruang.", err.classList.remove('hidden');
        auth.signInWithEmailAndPassword(e, p).catch(error => { err.innerText = "Log masuk gagal."; err.classList.remove('hidden'); });
    }
    
    function logoutSystem() { auth.signOut().then(() => location.reload()); }

    function renderSubjectGrid() {
        const grid = document.getElementById('subject-grid');
        grid.innerHTML = '';
        KPM_SUBJECTS.forEach(sub => {
            const isChecked = ['BM','BI','MT','SN','SJ','PAI'].includes(sub.id) ? 'checked' : '';
            grid.innerHTML += `<label class="flex items-center space-x-3 p-1.5 hover:bg-slate-50 cursor-pointer rounded"><input type="checkbox" value="${sub.id}" class="sub-checkbox w-4 h-4" ${isChecked} onchange="updateSelectedSubjects()"> <span class="font-medium">${sub.name}</span></label>`;
        });
        updateSelectedSubjects();
    }

    function updateSelectedSubjects() { 
        selectedSubjects = Array.from(document.querySelectorAll('.sub-checkbox:checked')).map(cb => cb.value); 
        if(currentClassData.length > 0) renderTable();
    }

    async function loadClassList() {
        const sesi = document.getElementById('sesiAkademik').value;
        const snap = await db.collection('sesi').doc(sesi).collection('kelas').get();
        const dd = document.getElementById('classDropdown');
        dd.innerHTML = '<option value="">-- Pilih Kelas --</option>' + snap.docs.map(d => `<option value="${d.id}">${d.data().nama_kelas || d.id}</option>`).join('');
        document.getElementById('class-area').classList.remove('hidden');
    }

    function startSync() {
        const sesi = document.getElementById('sesiAkademik').value;
        const jenis = document.getElementById('sesiPentaksiran').value;
        const kelas = document.getElementById('classDropdown').value;

        if(!kelas) { document.getElementById('manual-add-area').classList.add('hidden'); return; }
        document.getElementById('manual-add-area').classList.remove('hidden');

        db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(kelas).collection('murid')
          .onSnapshot(snap => {
                currentClassData = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderTable();
          });
    }

    async function deleteCurrentClass() {
        const sesi = document.getElementById('sesiAkademik').value;
        const jenis = document.getElementById('sesiPentaksiran').value;
        const kelas = document.getElementById('classDropdown').value;

        if(!kelas) return showToast("Sila pilih KELAS dahulu.", "error");
        if(!confirm(`AMARAN: Padam data murid untuk kelas ${kelas} sahaja?`)) return;
        if(prompt("Taip 'PADAM' untuk sahkan:") !== "PADAM") return;

        try {
            const classRef = db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(kelas);
            const muridSnap = await classRef.collection('murid').get();
            
            const batches = [];
            const BATCH_SIZE = 400;
            for (let i = 0; i < muridSnap.docs.length; i += BATCH_SIZE) {
                const batch = db.batch();
                muridSnap.docs.slice(i, i + BATCH_SIZE).forEach(doc => batch.delete(doc.ref));
                batches.push(batch.commit());
            }
            
            await Promise.all(batches);
            showToast("Data kelas berjaya dipadam!");
        } catch(e) { showToast("Ralat: " + e.message, "error"); }
    }

    async function deleteAllPentaksiranData() {
        const sesi = document.getElementById('sesiAkademik').value;
        const jenisID = document.getElementById('sesiPentaksiran').value;
        const sel = document.getElementById('sesiPentaksiran');
        const jenisNama = sel.options[sel.selectedIndex].text;

        if(!confirm(`AMARAN KRITIKAL!\n\nPadam SEMUA DATA untuk: ${jenisNama} (${sesi})?`)) return;
        
        const code = Math.floor(1000 + Math.random() * 9000);
        const input = prompt(`Taip kod: ${code}`);
        if(input !== code.toString()) return showToast("Kod salah.", "error");

        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = "‚è≥ MEMADAM...";
        btn.disabled = true;

        try {
            const kelasRef = db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenisID).collection('kelas');
            const kelasSnap = await kelasRef.get();

            let batch = db.batch();
            let count = 0;
            const BATCH_LIMIT = 400;

            for (const docKelas of kelasSnap.docs) {
                const muridSnap = await docKelas.ref.collection('murid').get();
                for (const docMurid of muridSnap.docs) {
                    batch.delete(docMurid.ref);
                    count++;
                    if (count % BATCH_LIMIT === 0) { await batch.commit(); batch = db.batch(); }
                }
                batch.delete(docKelas.ref);
                count++;
                if (count % BATCH_LIMIT === 0) { await batch.commit(); batch = db.batch(); }
            }

            if (count % BATCH_LIMIT !== 0) await batch.commit();

            showToast(`BERJAYA! ${count} rekod dipadam.`);
            setTimeout(() => location.reload(), 2000);

        } catch(e) {
            console.error(e);
            showToast("Ralat: " + e.message, "error");
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    async function addStudentManual() {
        const nama = document.getElementById('newStudentName').value.toUpperCase().trim();
        const sesi = document.getElementById('sesiAkademik').value;
        const jenis = document.getElementById('sesiPentaksiran').value;
        const kelas = document.getElementById('classDropdown').value;
        if(!nama || !kelas) return showToast("Isi nama dan pilih kelas.", "error");
        try {
            await db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(kelas).collection('murid').add({ nama: nama, marks: {} });
            document.getElementById('newStudentName').value = '';
            showToast("Murid ditambah.");
        } catch(e) { showToast("Ralat: " + e.message, "error"); }
    }

    async function processCSV() {
        const file = document.getElementById('csvInput').files[0];
        const sesi = document.getElementById('sesiAkademik').value;
        const jenis = document.getElementById('sesiPentaksiran').value;
        
        if (!file) return showToast("Pilih fail CSV!", "error");
        
        Papa.parse(file, {
            header: true, skipEmptyLines: true,
            complete: async (res) => {
                const data = res.data;
                if (data.length === 0) return showToast("Fail kosong.", "error");

                const firstRow = data[0];
                const keys = Object.keys(firstRow).map(k => k.toLowerCase().trim());
                if (!keys.includes('nama') || !keys.includes('kelas')) {
                    return showToast("Format CSV salah! Pastikan ada lajur 'NAMA' dan 'KELAS'", "error");
                }

                const BATCH_SIZE = 400;
                let processedCount = 0;

                for (let i = 0; i < data.length; i += BATCH_SIZE) {
                    const chunk = data.slice(i, i + BATCH_SIZE);
                    const batch = db.batch();
                    
                    chunk.forEach(row => {
                        const d = Object.keys(row).reduce((acc, k) => { acc[k.toLowerCase().trim()] = row[k]; return acc; }, {});
                        if (d.nama && d.kelas) {
                            const cid = d.kelas.toString().replace(/[^a-zA-Z0-9]/g,'_').toUpperCase(); 
                            const cRefMeta = db.collection('sesi').doc(sesi).collection('kelas').doc(cid);
                            batch.set(cRefMeta, { nama_kelas: d.kelas.toUpperCase() }, { merge: true });
                            
                            const mRef = db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(cid).collection('murid').doc();
                            batch.set(mRef, { nama: d.nama.toUpperCase(), marks: {} });
                        }
                    });

                    await batch.commit();
                    processedCount += chunk.length;
                    showToast(`Memproses ${processedCount}/${data.length}...`);
                }

                showToast("Import Selesai!");
                loadClassList();
            }
        });
    }

    async function updateMark(sid, sub, val) {
        const sesi = document.getElementById('sesiAkademik').value;
        const jenis = document.getElementById('sesiPentaksiran').value;
        const kelas = document.getElementById('classDropdown').value;
        
        let cleanVal = parseFloat(val);
        if (isNaN(cleanVal)) cleanVal = 0;
        if (cleanVal < 0) cleanVal = 0;
        if (cleanVal > 100) cleanVal = 100;

        const inputEl = document.activeElement;
        if (inputEl && inputEl.value != cleanVal && val !== "") {
            inputEl.value = cleanVal;
        }

        await db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(kelas).collection('murid').doc(sid).set({ marks: {[sub]: cleanVal} }, {merge: true});
    }

    async function deleteStudent(sid) {
        if(!confirm("Padam murid ini?")) return;
        const sesi = document.getElementById('sesiAkademik').value;
        const jenis = document.getElementById('sesiPentaksiran').value;
        const kelas = document.getElementById('classDropdown').value;
        await db.collection('sesi').doc(sesi).collection('pentaksiran').doc(jenis).collection('kelas').doc(kelas).collection('murid').doc(sid).delete();
        showToast("Murid dipadam.");
    }

    function renderTable() {
        const search = document.getElementById('searchInput').value.toUpperCase();
        const header = document.getElementById('tableHeader');
        const body = document.getElementById('tableBody');
        header.innerHTML = `<th class="p-4">NAMA MURID</th>` + selectedSubjects.map(s => `<th class="p-2 text-center bg-blue-800">${s}</th>`).join('') + `<th class="p-2 text-center bg-slate-700">GPM</th><th class="p-2 text-center bg-red-600">DEL</th>`;
        const sorted = [...currentClassData].filter(m => m.nama.includes(search)).sort((a,b) => a.nama.localeCompare(b.nama));
        
        body.innerHTML = sorted.map(m => `
            <tr class="border-b hover:bg-blue-50 transition">
                <td class="p-4 font-bold uppercase text-slate-700 text-xs">${m.nama}</td>
                ${selectedSubjects.map(sub => `<td class="p-2 text-center"><input type="number" min="0" max="100" class="mark-input focus:bg-yellow-100" value="${m.marks?.[sub] !== undefined ? m.marks[sub] : ''}" onchange="updateMark('${m.id}', '${sub}', this.value)"></td>`).join('')}
                <td class="p-2 text-center font-black text-blue-600">${m.gpm || '-'}</td>
                <td class="p-2 text-center"><button onclick="deleteStudent('${m.id}')" class="text-red-400 hover:text-red-600 font-bold">üóëÔ∏è</button></td>
            </tr>`).join('');
        document.getElementById('table-card').classList.remove('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('stat-murid').innerText = currentClassData.length;
    }

    function calculate() {
        const getGrade = (m) => { m=parseFloat(m)||0; if(m>=80)return{g:'A',p:1}; if(m>=70)return{g:'B',p:2}; if(m>=60)return{g:'C',p:3}; if(m>=50)return{g:'D',p:4}; if(m>=40)return{g:'E',p:5}; return{g:'F',p:6}; };
        const core = ['BM','BI','MT','SN','SJ','PAI']; 
        let totalPass=0;
        
        currentClassData.forEach(s => {
            let tm=0, tp=0, count=0, l=true;
            selectedSubjects.forEach(sub => { 
                let m=s.marks?.[sub]; 
                if(m!==undefined&&m!==""){ 
                    m=parseFloat(m); 
                    if(m>100) m=100; 
                    let r=getGrade(m); 
                    tm+=m; tp+=r.p; count++; 
                    if(core.includes(sub)&&m<40)l=false; 
                } 
            });
            s.gpm = count>0?(tp/count).toFixed(2):'0.00'; 
            s.percent=count>0?((tm/(count*100))*100).toFixed(2):'0.00'; 
            s.statusLulus=(count>0&&l)?"LULUS":"GAGAL"; 
            if(s.statusLulus==="LULUS")totalPass++; 
            s.totalMarks=tm;
        });
        
        const sorted = [...currentClassData].sort((a,b)=>parseFloat(a.gpm)-parseFloat(b.gpm)||b.totalMarks-a.totalMarks);
        currentClassData.forEach(s => s.rank=sorted.findIndex(r=>r.id===s.id)+1);
        
        document.getElementById('stat-gpm').innerText=(currentClassData.reduce((a,b)=>a+parseFloat(b.gpm||0),0)/(currentClassData.length||1)).toFixed(2);
        document.getElementById('stat-lulus').innerText=((totalPass/(currentClassData.length||1))*100).toFixed(1)+"%";
        document.getElementById('top-5-list').innerHTML=sorted.slice(0,5).map((s,i)=>`<div class="flex justify-between items-center p-2 border-b text-[11px]"><span>${i+1}. <b>${s.nama}</b></span><span class="bg-emerald-100 text-emerald-800 px-2 rounded font-black">GPM: ${s.gpm}</span></div>`).join('');
        
        document.getElementById('excellence-panel').classList.remove('hidden'); 
        document.getElementById('print-btn-area').classList.remove('hidden');
        renderTable(); 
        generateSijil(getGrade);
        showToast("Analisis & Sijil Dijana!");
    }

    function generateSijil(getGrade) {
        const sortedAZ = [...currentClassData].sort((a, b) => a.nama.localeCompare(b.nama));
        const sel = document.getElementById('sesiPentaksiran');
        const pentaksiran = sel.options[sel.selectedIndex].text;
        const sesi = document.getElementById('sesiAkademik').value;
        
        document.getElementById('section-sijil').innerHTML = sortedAZ.map(s => `
            <div class="page-break">
                <div class="certificate-border">
                    <div class="text-center">
                        <img src="https://via.placeholder.com/100x100?text=SKAG" class="w-24 mx-auto mb-4" onerror="this.style.display='none'">
                        <h2 class="text-2xl font-black text-blue-900">SK ABANG GESA, BELAWAI</h2>
                        <p class="text-xs font-bold text-slate-500 uppercase">${pentaksiran} (${sesi})</p>
                    </div>
                    <div class="text-center">
                        <h1 style="font-family: 'Cinzel', serif;" class="text-5xl font-bold text-blue-900">SIJIL PENCAPAIAN</h1>
                        <p class="mt-4 italic text-sm text-slate-500">Dianugerahkan kepada</p>
                        <h2 class="text-3xl font-black my-4 uppercase text-blue-950 border-b-4 border-double border-blue-900 inline-block px-12 pb-2">${s.nama}</h2>
                    </div>
                    <div class="flex justify-center flex-grow py-4">
                        <table class="w-11/12 border-2 border-slate-800 text-[11px]">
                            <thead class="bg-blue-900 text-white uppercase text-sm">
                                <tr><th class="p-3 border text-left">MATAPELAJARAN</th><th class="p-3 border text-center">MARKAH</th><th class="p-3 border text-center">GRED</th></tr>
                            </thead>
                            <tbody class="font-bold">
                                ${selectedSubjects.map(sub => { 
                                    let m=s.marks?.[sub]; 
                                    if(m===undefined||m==="")return""; 
                                    return `<tr><td class="border border-slate-800 p-2 px-6 uppercase">${KPM_SUBJECTS.find(k=>k.id===sub)?.name||sub}</td><td class="border border-slate-800 text-center p-2 text-base">${m}</td><td class="border border-slate-800 text-center p-2 text-base font-black text-blue-900">${getGrade(m).g}</td></tr>`; 
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="grid grid-cols-4 gap-4 text-center max-w-3xl mx-auto font-black text-xs w-full">
                        <div class="bg-slate-100 p-3 border rounded-xl">GPM: ${s.gpm}</div>
                        <div class="bg-slate-100 p-3 border rounded-xl">KEDUDUKAN: ${s.rank}</div>
                        <div class="bg-blue-900 text-white p-3 rounded-xl uppercase">${s.statusLulus}</div>
                        <div class="bg-slate-100 p-3 border rounded-xl">PERATUS: ${s.percent}%</div>
                    </div>
                    <div class="mt-12 flex justify-between px-16 text-sm font-black text-center uppercase">
                        <div class="w-56"><div class="border-b-2 border-black h-12 mb-2"></div><p>Guru Kelas</p></div>
                        <div class="w-56"><div class="border-b-2 border-black h-12 mb-2"></div><p>Guru Besar</p></div>
                    </div>
                </div>
            </div>`).join('');
    }

    function exportToExcel() {
        const data = currentClassData.map(m => ({ Nama: m.nama, ...m.marks, GPM: m.gpm, Rank: m.rank, Status: m.statusLulus }));
        const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Analisis"); XLSX.writeFile(wb, `Analisis_SKAG.xlsx`);
        showToast("Fail Excel dimuat turun.");
    }
</script>
</body>
</html>
