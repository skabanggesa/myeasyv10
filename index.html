<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Digital & MyEASy V10</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --kurikulum: #3b82f6; --hem: #f59e0b; --koko: #10b981; --bg: #f8fafc; --dark-blue: #1e293b; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg); margin: 0; color: #334155; }
        
        /* Auth Screen */
        #auth-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); }
        .auth-container { max-width: 400px; width: 90%; padding: 30px; background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .auth-btn { width: 100%; padding: 12px; background: var(--dark-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }

        /* Portal UI */
        header { background: var(--dark-blue); color: white; padding: 15px; text-align: center; }
        .unit-card { cursor: pointer; transition: 0.3s; background: white; border-radius: 15px; padding: 20px; border-bottom: 6px solid #cbd5e1; }
        .unit-card:hover { transform: translateY(-5px); }
        
        /* MyEASy Specific Styles */
        .certificate-border { border: 20px double #1e3a8a; padding: 50px; background: white; min-height: 1050px; display: flex; flex-direction: column; position: relative; }
        .mark-input { width: 55px; padding: 2px; text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; font-weight: bold; font-size: 12px; }
        
        @media print {
            body * { visibility: hidden; }
            #section-sijil, #section-sijil * { visibility: visible; }
            #section-sijil { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            .page-break { page-break-after: always; }
        }
    </style>
</head>
<body class="bg-slate-50">

    <div id="auth-screen">
        <div class="auth-container">
            <img src="logo.png" class="w-20 mx-auto mb-4" onerror="this.src='https://via.placeholder.com/80'">
            <h2 id="auth-title" class="text-xl font-bold mb-4">Log Masuk Portal</h2>
            <div id="reg-fields" style="display: none;">
                <input type="text" id="reg-name" class="auth-input" placeholder="NAMA PENUH (HURUF BESAR)" oninput="this.value = this.value.toUpperCase()">
            </div>
            <input type="email" id="auth-email" class="auth-input" placeholder="Emel @moe-dl.edu.my">
            <input type="password" id="auth-password" class="auth-input" placeholder="Kata Laluan">
            <button onclick="handleAuth()" class="auth-btn">MASUK</button>
            <p class="text-xs mt-4 text-blue-600 cursor-pointer" onclick="toggleAuth()">Belum mendaftar? Klik sini.</p>
        </div>
    </div>

    <div id="main-portal" class="hidden no-print">
        <header>
            <img src="logo.png" class="w-12 mx-auto mb-2">
            <h1 class="text-lg font-bold uppercase">Portal Digital Guru SK Abang Gesa</h1>
            <p id="user-display" class="text-yellow-400 text-xs font-bold"></p>
            <button onclick="logout()" class="mt-2 bg-red-600 px-4 py-1 rounded-full text-[10px] font-bold">LOG KELUAR</button>
        </header>

        <div class="p-6 max-w-6xl mx-auto">
            <div id="main-menu" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="unit-card border-blue-500 text-blue-600 text-center" onclick="showSection('kurikulum')">
                    <i class="fa-solid fa-graduation-cap text-4xl mb-2"></i>
                    <h2 class="font-bold">KURIKULUM</h2>
                </div>
                <div class="unit-card border-amber-500 text-amber-600 text-center" onclick="showSection('hem')">
                    <i class="fa-solid fa-hand-holding-heart text-4xl mb-2"></i>
                    <h2 class="font-bold">HEM</h2>
                </div>
                <div class="unit-card border-emerald-500 text-emerald-600 text-center" onclick="showSection('koko')">
                    <i class="fa-solid fa-volleyball text-4xl mb-2"></i>
                    <h2 class="font-bold">KOKURIKULUM</h2>
                </div>
            </div>

            <div id="sec-kurikulum" class="hidden space-y-4">
                <button onclick="backToMenu()" class="text-sm font-bold text-slate-500"><i class="fa-solid fa-arrow-left"></i> KEMBALI</button>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-xl border text-center cursor-pointer hover:bg-blue-50" onclick="openMyEasy()">
                        <img src="myeasy.png" class="w-10 mx-auto mb-2" onerror="this.src='https://via.placeholder.com/40'">
                        <h3 class="font-bold text-sm">MyEASy V10</h3>
                        <p class="text-[10px] text-slate-400">Analisis & Penjanaan Sijil</p>
                    </div>
                </div>
            </div>

            <div id="sec-hem" class="hidden">... HEM Dalam Pembinaan ...</div>
            <div id="sec-koko" class="hidden">... KOKO Dalam Pembinaan ...</div>

            <div id="myeasy-app" class="hidden bg-slate-100 -m-6 p-6 min-h-screen">
                <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border-b-4 border-blue-900">
                    <h2 class="font-black text-blue-900 uppercase">MyEASy V10 - Integrasi Portal</h2>
                    <button onclick="closeMyEasy()" class="bg-slate-700 text-white px-4 py-1 rounded text-xs font-bold">TUTUP MODULE</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm border">
                            <h3 class="text-[10px] font-bold text-blue-700 mb-3 border-b pb-1">‚öôÔ∏è TETAPAN SESI</h3>
                            <label class="text-[9px] font-bold text-slate-400 block uppercase">Sesi Akademik</label>
                            <select id="sesiAkademik" onchange="loadClassList()" class="w-full p-2 border rounded mb-3 text-xs font-bold">
                                <option value="2024_2025">2024/2025</option><option value="2025_2026">2025/2026</option>
                            </select>
                            <label class="text-[9px] font-bold text-slate-400 block uppercase">Jenis Pentaksiran</label>
                            <select id="sesiPentaksiran" onchange="startSync()" class="w-full p-2 border rounded mb-3 text-xs font-bold">
                                <option value="Ujian_Akhir_Sesi_Akademik">UASA</option>
                                <option value="Pentaksiran_Pertengahan_Tahun">PPT</option>
                            </select>
                            <div id="class-area" class="hidden">
                                <label class="text-[9px] font-bold text-slate-400 block uppercase">Pilih Kelas</label>
                                <select id="classDropdown" onchange="startSync()" class="w-full p-2 border border-amber-300 rounded text-xs font-bold bg-amber-50"></select>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-xl shadow-sm border">
                            <h3 class="text-[10px] font-bold text-blue-700 mb-2 uppercase">üì• Import Murid (CSV)</h3>
                            <input type="file" id="csvInput" accept=".csv" class="w-full text-[9px] mb-2">
                            <button onclick="processCSV()" class="w-full bg-blue-600 text-white py-1.5 rounded text-[10px] font-bold">PROSES CSV</button>
                        </div>

                        <div class="bg-white p-4 rounded-xl shadow-sm border">
                            <h3 class="text-[10px] font-bold text-blue-700 mb-2 uppercase">üìö Matapelajaran</h3>
                            <div id="subject-grid" class="space-y-1 text-[10px]"></div>
                        </div>
                    </div>

                    <div class="lg:col-span-3 space-y-6">
                        <div id="dashboard" class="grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
                            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-600">
                                <p class="text-[9px] font-bold text-slate-400">GPM KELAS</p>
                                <p id="stat-gpm" class="text-2xl font-black text-blue-900">-</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500">
                                <p class="text-[9px] font-bold text-slate-400">% LULUS</p>
                                <p id="stat-lulus" class="text-2xl font-black text-emerald-600">-</p>
                            </div>
                            <button onclick="calculate()" class="bg-blue-900 text-white rounded-xl font-black text-xs uppercase shadow-lg">üöÄ Jana Sijil</button>
                            <button onclick="exportToExcel()" class="bg-emerald-600 text-white rounded-xl font-black text-xs uppercase shadow-lg">üìä Excel</button>
                        </div>

                        <div id="table-card" class="bg-white rounded-xl shadow-sm border overflow-hidden hidden">
                            <div class="p-3 bg-slate-50 border-b">
                                <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="Cari nama murid..." class="w-full p-2 border rounded-lg text-xs outline-none">
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead class="bg-blue-900 text-white text-[9px] uppercase"><tr id="tableHeader"></tr></thead>
                                    <tbody id="tableBody" class="text-xs"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="print-area" class="hidden flex justify-center">
                            <button onclick="window.print()" class="bg-blue-900 text-white px-10 py-3 rounded-full font-black text-lg shadow-xl">üñ®Ô∏è CETAK SEMUA SIJIL</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="section-sijil"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, onSnapshot, query, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCwh99Ui4KPXgC-W-CpCg-edYnHN3aVmrk",
            authDomain: "portal-8368.firebaseapp.com",
            projectId: "portal-8368",
            storageBucket: "portal-8368.firebasestorage.app",
            messagingSenderId: "150403488308",
            appId: "1:150403488308:web:fac9b3c52dcd9975130861"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // -- AUTH LOGIC --
        let isLoginMode = true;
        window.toggleAuth = () => {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-title').innerText = isLoginMode ? "Log Masuk Portal" : "Daftar Akaun Baru";
            document.getElementById('reg-fields').style.display = isLoginMode ? "none" : "block";
        };

        window.handleAuth = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-password').value;
            try {
                if(isLoginMode) await signInWithEmailAndPassword(auth, email, pass);
                else {
                    const name = document.getElementById('reg-name').value;
                    const userCred = await createUserWithEmailAndPassword(auth, email, pass);
                    await updateProfile(userCred.user, { displayName: name });
                    await setDoc(doc(db, "pengguna", userCred.user.uid), { nama: name, emel: email });
                    alert("Berjaya mendaftar!");
                }
            } catch (e) { alert("Ralat: " + e.message); }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-portal').classList.remove('hidden');
                document.getElementById('user-display').innerText = "SELAMAT DATANG, " + (user.displayName || "GURU");
                loadClassList();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('main-portal').classList.add('hidden');
            }
        });

        window.logout = () => signOut(auth);

        // -- PORTAL NAVIGATION --
        window.showSection = (id) => {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('sec-' + id).classList.remove('hidden');
        };
        window.backToMenu = () => {
            document.querySelectorAll('[id^="sec-"]').forEach(s => s.classList.add('hidden'));
            document.getElementById('main-menu').classList.remove('hidden');
        };

        // -- MYEASY LOGIC (MODERNIZED) --
        const SUBJECTS = [
            {id:'BM', name:'BAHASA MELAYU'}, {id:'BI', name:'BAHASA INGGERIS'}, {id:'MT', name:'MATEMATIK'}, 
            {id:'SN', name:'SAINS'}, {id:'SJ', name:'SEJARAH'}, {id:'PAI', name:'PENDIDIKAN ISLAM'},
            {id:'MZ', name:'PENDIDIKAN MUZIK'}, {id:'PJK', name:'PJK'}, 
            {id:'PSV', name:'PSV'}, {id:'RBT', name:'RBT'}
        ];
        let currentClassData = [], selectedSubjects = [];

        window.openMyEasy = () => {
            document.getElementById('sec-kurikulum').classList.add('hidden');
            document.getElementById('myeasy-app').classList.remove('hidden');
            renderSubjectGrid();
        };

        window.closeMyEasy = () => {
            document.getElementById('myeasy-app').classList.add('hidden');
            document.getElementById('sec-kurikulum').classList.remove('hidden');
        };

        function renderSubjectGrid() {
            const grid = document.getElementById('subject-grid');
            grid.innerHTML = SUBJECTS.map(s => `
                <label class="flex items-center gap-2 p-1 hover:bg-slate-50 rounded">
                    <input type="checkbox" value="${s.id}" class="sub-cb" checked onchange="updateSelectedSubs()">
                    <span>${s.name}</span>
                </label>
            `).join('');
            updateSelectedSubs();
        }

        window.updateSelectedSubs = () => {
            selectedSubjects = Array.from(document.querySelectorAll('.sub-cb:checked')).map(cb => cb.value);
            if(currentClassData.length > 0) renderTable();
        };

        window.loadClassList = async () => {
            const sesi = document.getElementById('sesiAkademik').value;
            const snap = await getDocs(collection(db, "sesi", sesi, "kelas"));
            document.getElementById('classDropdown').innerHTML = '<option value="">-- Pilih Kelas --</option>' + 
                snap.docs.map(d => `<option value="${d.id}">${d.data().nama_kelas || d.id}</option>`).join('');
            document.getElementById('class-area').classList.remove('hidden');
        };

        let unsubscribe = null;
        window.startSync = () => {
            const sesi = document.getElementById('sesiAkademik').value;
            const jenis = document.getElementById('sesiPentaksiran').value;
            const kelas = document.getElementById('classDropdown').value;
            if(!kelas) return;

            if(unsubscribe) unsubscribe();
            const q = collection(db, "sesi", sesi, "pentaksiran", jenis, "kelas", kelas, "murid");
            unsubscribe = onSnapshot(q, (snap) => {
                currentClassData = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderTable();
            });
        };

        window.renderTable = () => {
            const search = document.getElementById('searchInput').value.toUpperCase();
            const header = document.getElementById('tableHeader');
            const body = document.getElementById('tableBody');
            
            header.innerHTML = `<th class="p-3">NAMA MURID</th>` + selectedSubjects.map(s => `<th class="p-2 text-center bg-blue-800">${s}</th>`).join('') + `<th class="p-2 text-center bg-slate-700">GPM</th>`;
            
            const filtered = currentClassData.filter(m => m.nama.includes(search)).sort((a,b) => a.nama.localeCompare(b.nama));
            body.innerHTML = filtered.map(m => `
                <tr class="border-b bg-white hover:bg-blue-50">
                    <td class="p-3 font-bold uppercase text-[10px]">${m.nama}</td>
                    ${selectedSubjects.map(sub => `<td class="p-1 text-center"><input type="number" class="mark-input" value="${m.marks?.[sub] || 0}" onchange="updateMark('${m.id}', '${sub}', this.value)"></td>`).join('')}
                    <td class="p-1 text-center font-bold text-blue-600">${m.gpm || '0.00'}</td>
                </tr>
            `).join('');
            
            document.getElementById('table-card').classList.remove('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        };

        window.updateMark = async (mid, sub, val) => {
            const sesi = document.getElementById('sesiAkademik').value;
            const jenis = document.getElementById('sesiPentaksiran').value;
            const kelas = document.getElementById('classDropdown').value;
            const ref = doc(db, "sesi", sesi, "pentaksiran", jenis, "kelas", kelas, "murid", mid);
            await updateDoc(ref, { [`marks.${sub}`]: parseFloat(val) || 0 });
        };

        window.processCSV = async () => {
            const file = document.getElementById('csvInput').files[0];
            const sesi = document.getElementById('sesiAkademik').value;
            const jenis = document.getElementById('sesiPentaksiran').value;
            if(!file) return alert("Pilih fail CSV!");

            Papa.parse(file, {
                header: true, skipEmptyLines: true,
                complete: async (res) => {
                    const batch = writeBatch(db);
                    for(const row of res.data) {
                        const nama = row.Nama || row.NAMA;
                        const kName = row.Kelas || row.KELAS;
                        if(nama && kName) {
                            const cid = kName.replace(/\s+/g,'_').toUpperCase();
                            const mRef = doc(collection(db, "sesi", sesi, "pentaksiran", jenis, "kelas", cid, "murid"));
                            batch.set(doc(db, "sesi", sesi, "kelas", cid), { nama_kelas: kName.toUpperCase() }, {merge:true});
                            batch.set(mRef, { nama: nama.toUpperCase(), marks: {} });
                        }
                    }
                    await batch.commit();
                    alert("Import Berjaya!"); loadClassList();
                }
            });
        };

        window.calculate = () => {
            const getGrade = (m) => {
                if(m>=80) return {g:'A',p:1}; if(m>=70) return {g:'B',p:2}; if(m>=60) return {g:'C',p:3};
                if(m>=50) return {g:'D',p:4}; if(m>=40) return {g:'E',p:5}; return {g:'F',p:6};
            };
            
            let totalGpm = 0;
            currentClassData.forEach(s => {
                let tp = 0, tm = 0;
                selectedSubjects.forEach(sub => {
                    let m = s.marks?.[sub] || 0; let res = getGrade(m);
                    tp += res.p; tm += m;
                });
                s.gpm = (tp / (selectedSubjects.length || 1)).toFixed(2);
                s.totalMarks = tm;
                totalGpm += parseFloat(s.gpm);
            });

            const sorted = [...currentClassData].sort((a,b) => a.gpm - b.gpm || b.totalMarks - a.totalMarks);
            currentClassData.forEach(s => s.rank = sorted.findIndex(r => r.id === s.id) + 1);

            document.getElementById('stat-gpm').innerText = (totalGpm / (currentClassData.length || 1)).toFixed(2);
            generateCertificates(getGrade);
            renderTable();
            document.getElementById('print-area').classList.remove('hidden');
        };

        function generateCertificates(getGrade) {
            const pentaksiran = document.getElementById('sesiPentaksiran').value.replace(/_/g,' ');
            document.getElementById('section-sijil').innerHTML = currentClassData.sort((a,b)=>a.nama.localeCompare(b.nama)).map(s => `
                <div class="page-break"><div class="certificate-border">
                    <div class="text-center mb-6"><img src="logo.png" class="w-16 mx-auto mb-2"><h2 class="text-xl font-black text-blue-900">SK ABANG GESA, BELAWAI</h2><p class="text-[10px] font-bold uppercase">${pentaksiran}</p></div>
                    <div class="text-center mb-6"><h1 style="font-family:'Cinzel'" class="text-4xl font-bold text-blue-900">SIJIL PENCAPAIAN</h1><p class="italic text-xs">Dianugerahkan kepada</p><h2 class="text-2xl font-black my-2 uppercase border-b-2 border-blue-900 inline-block px-10">${s.nama}</h2></div>
                    <div class="flex-grow">
                        <table class="w-10/12 mx-auto border-2 border-slate-800 text-[10px] font-bold">
                            <thead class="bg-blue-900 text-white"><tr><th class="p-2 border text-left">MATAPELAJARAN</th><th class="p-2 border text-center">MARKAH</th><th class="p-2 border text-center">GRED</th></tr></thead>
                            <tbody>
                                ${selectedSubjects.map(sub => `<tr><td class="border border-slate-800 p-1.5 px-4">${SUBJECTS.find(k=>k.id===sub).name}</td><td class="border border-slate-800 text-center">${s.marks?.[sub]||0}</td><td class="border border-slate-800 text-center text-blue-900">${getGrade(s.marks?.[sub]||0).g}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-10 grid grid-cols-2 gap-4 text-center max-w-md mx-auto font-black text-[10px]">
                        <div class="bg-slate-100 p-2 rounded">GPM: ${s.gpm}</div><div class="bg-slate-100 p-2 rounded">KEDUDUKAN: ${s.rank}</div>
                    </div>
                    <div class="mt-16 flex justify-between px-16 text-[10px] font-bold text-center uppercase"><div class="w-40 border-t border-black pt-1">Guru Kelas</div><div class="w-40 border-t border-black pt-1">Guru Besar</div></div>
                </div></div>`).join('');
        }

        window.exportToExcel = () => {
            const data = currentClassData.map(m => ({ Nama: m.nama, ...m.marks, GPM: m.gpm, Rank: m.rank }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Analisis");
            XLSX.writeFile(wb, `Analisis_SKAG_${Date.now()}.xlsx`);
        };
    </script>
</body>
</html>
